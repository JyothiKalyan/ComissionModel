<html>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  
  
  <link href=https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css rel=stylesheet>
  
  <!--<table data-sort-name=stargazers_count data-sort-order=desc  -->
    <script src=https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js></script>





    <style>
        .Insights_title{
    color:white;
    font-size: 30px;
    background-color: black;
   
    padding-top:30px;
    text-align: center;
    font-family: 'Montserrat', sans-serif;
   
}
.input_box_span{
    position: relative;
    display: inline;
    float: left;
    width: 300px;
    margin-left:100px;
}
.page-title{
    position:relative;
    z-index:100;
    color:white;
    font-size:35;
    background-color: black;
    text-align: center;
}

.chart_title{
            clear:both;
            font-family: 'Open Sans', sans-serif;
            font-size:24px;
            text-align:center;
            font-weight: bold;
            padding-bottom:10px;
            background-color: #d1d1d1;
        }
        .chart_sub_title{
            font-size:14px;
            font-family: 'Open Sans', sans-serif;
            text-align:center;
            color:blue;
            background-color: #d1d1d1;
        }

.section-title{
            clear:both;
            font-family: 'Open Sans', sans-serif;
            font-size:24px;
            
            position:relative;
            float: left;
            display: inline;
            text-align:center;
           
            font-weight:bold;
            
        }


          .manager_detail_class{
            padding:10px;
            position: relative;
            width: 400px;
            display: inline;
            float: left;
        }

        .plan_table{
            position:relative;
            width:30%;
            top:20px;
            display:inline;
            float:left;
            padding-left:20px;
        }

        .section-sub-title{
            font-size: 15px;
        }


.si{
    position: relative;
    display: inline;
    width: 200px !important;
}

.chart_description{
    clear:both;
    color:red;
    font-size: 14px;
    text-align:center;
}

.custom-scroll{
    position:relative;
    /*direction:rtl;*/
   
    position: relative;
    margin-bottom: 100px;
    display: inline-block;
    float: left;
    width: 100%;
    overflow-x: scroll;
    background-color:rgb(238 238 238);
    

}

    </style>

<body>

    <div class='page-title'>  Business Planning overview - Yearly <br>
        <span style='font-size:20px'> Target Sale computation by balancing achievement% and headcount adhering  18% capping | Target Volume analysis</span><br>

        <span class='chart_sub_title' style='background-color: black;color:#a5a5f3'> The Suggestion -- Explaination to arrival of suggestion -- Evaluating suggestion   </span>
    </div>

    <div style='padding-left:50px;padding-right:50px'> 
        <div class='inputs' style='padding-left:150px'>
    <div>
    <span class='section-title'> Known factors 
        <span  class='section-sub-title'>(The Maximum value of factors which are less probable to change. )</span></span><br>

    <br>
    <span style='padding-left:40px'> Fixed Operation Cost: <input id='fixed_operation_cost' value=12000000>   <span id="fixed_operation_cost_Label"></span></span>
    <span style='padding-left:40px'> Operation Cost per person (per Month):  <input id='operation_cost_per_person' value=3500>  <span id="operation_cost_per_person_Label"></span></span>
    <span style='padding-left:40px'> EEEE Volume Target:  <input id='EEEE_Volume_Target' value=200000000>  <span id="EEEE_Volume_Target_Label"></span></span>

    <br>Monthly Target Per Staff:     <span style='padding-left:40px'>Property Consultants Target:  <input id='PropertyConsultant_Target' value=45000>   </span> <span id="PropertyConsultant_Target_Label"></span>
    <span style='padding-left:40px'>  Sr. Property Consultants Target: <input id='SrPropertyConsultant_Target'  value=65000> </span><span id="SrPropertyConsultant_Target_Label"></span>
    <span style='padding-left:40px'>  Leasing Consultants Target: <input id='LeasingConsultants_Target'  value=55000> </span><span id="LeasingConsultants_Target_Label"></span>


    <div style='clear:both;padding-top:20px'>
        <table class='plan_table' >
            <th>PLAN-1 (EEEE, Target_Achieved)</th> 
            <tr><td><100%</td><td> 0 </td></tr>
            <tr><td>85% -100%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c1_p1"></td></tr>
            <tr><td>100% -150%</td><td><input style='width:50px' type="number" min="0"  step="1" value="6" id="cap_c2_p1"></td></tr>
            <tr><td>150% -200%</td><td><input style='width:50px' type="number" min="0"  step="1" value="8" id="cap_c3_p1"></td></tr>
            <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="10" id="cap_c4_p1"></td></tr>
        </table>

        <table class='plan_table' > 
        <th>PLAN-2 (NON EEEE)</th>
        <tr><td><85%</td><td> 0 </td></tr>
        <tr><td>85% -100%</td><td><input style='width:50px' type="number" min="0"  step="1" value="2" id="cap_c1_p2"></td></tr>
        <tr><td>100% -150%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c2_p2"></td></tr>
        <tr><td>150% -200%</td><td><input style='width:50px' type="number" min="0"  step="1" value="4" id="cap_c3_p2"></td></tr>
        <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="5" id="cap_c4_p2"></td></tr>
    </table>

        <table class='plan_table'> 
            <th> PLAN-3 (General Manager) </th>
        <tr><td><100%</td><td>0</td></tr>
        <tr><td>100% -125%</td><td><input style='width:50px' type="number" min="0"  step="1" value="2" id="cap_c1_p3"></td></tr>
        <tr><td>125% -200%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c2_p3"></td></tr>
        <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="6" id="cap_c3_p3"></td></tr>
    </table>
    </div>
    <br>


<div id="Manager_details" style="clear:both;top:50px;position: relative;">

    <button id='add_default_manager' style='position:relative;background-color: #5b8f01;' type="button" class="btn btn-primary"> +Add Default 3 Managers </button>

    <button id='add_manager' style='position:relative;background-color: #5b8f01;' type="button" class="btn btn-primary"> +Add Manager </button>

    <div id='Manager_details_generate'>

    </div>

 



</div>

</div>

<div style="clear:both ;position:relative;top:50px">
<br>
    <span class='section-title'> Volatile Parameters
        <span  class='section-sub-title'>(These influence payout multiplicatively, and are highly variable )</span></span> <br>
<div style='clear:both'>
    <span class ='input_box_span' > EEEE Volume-> Sale Comission Percent Range: <input class="slider si" type="range"  min="2.5" max="10" value="3.5" step= .5 id='EEEE_Comission_Percentage_Range'> <span id="EEEE_Comission_Percentage_Range_Label"></span> </span>
    <span class ='input_box_span' >  NON-EEEE Volume-> Sale Comission Percent Range:  <input class="slider si" type="range" min="2.5" value="4" max="8" step= .5 id='NON_EEEE_Comission_Percentage_Range'> <span id="NON_EEEE_Comission_Percentage_Range_Label"></span></span>
    <span class ='input_box_span' > Staff Comission Percent Range: <input class="slider si" type="range" min="55" max="70" step= 1 value="61" id='Staff_Comission_Percentage_Range'> <span id="Staff_Comission_Percentage_Range_Label"></span></span>

</div>
</div>
    
<br>
Achievement%  <br>
<input class="slider si" type="range"  min="100" max="600" value="400" step= 50 id='Achievement_Percentage_Range'> <span id='Achievement_Percentage_Range_Label'></span>

  <button id='simulate' style='clear:both;position:relative;top:50px' type="button" class="btn btn-primary">What should target be?</button>
  </div>
    <div style='clear:both;position: relative;top:100px'>

        <div id='section1'>
            <div  class='Insights_title' style='padding-bottom:40px'>

                &#10004 Manager Payout is influenced by Achievement% & headcount (Target)
            </div>
            <div style='background-color:#eee;'>
                <div  class='chart_title'> <span id='section_2_ct'> Manager Payout increases with Achievement% ; increases with headcount (Target) </span> 
                     <span id='section_2_st'  class='chart_sub_title'> so, balance of headcount & achievement% should be chosen </span> </div>
                <div class='chart_description' style='padding-bottom:5px'> Simulation Adherence to Managers Expectation & 18% Capping </span> </div>
               
                <div id='section1_chart'>

                </div>
              
                <div id='scenario_table_header_1' class='Insights_title'  style='clear:both;padding-top: 0px;'> 
                    
                    Showing simulated scenarios for <span id='scenario_1_manager'></span> 
                    for Achievement% <span id='scenario_1_staff_increase_factor'  ></span>
                    for Staff_increase_Factor% <span id='scenario_1_achievement'  ></span>
                    Target<span id='scenario_1_staff_Target'></span>
                

                </div>
                <div id='scenario'  style='clear:both;position:relative;max-height:400px;overflow-y: scroll;'>
                    <table id='scenario_table_section_1' style='position:relative;max-height:400px;overflow-y: scroll;'>
                    
                    </table>
                </div>
              

                </div>
        </div>

        <div id='section2'>

            <div>
                <div  class='Insights_title' style='padding-bottom:40px'>
                    &#10004 Staff are added gradually through out the year , so, headcount suggestion should reflect alreadya chieved target         
                </div>

                <div  class='chart_title'> <span id='section_2_ct'> As achievement% increases, headcount should be increased to adhere capping  </span> 
                    <span id='section_2_st'  class='chart_sub_title'> increasing Target & suggest #people to onboard - 
                     No scenario of decreasing target</span> </div>
               <div class='chart_description' style='padding-bottom:5px'> Simulation Adherence to Managers Expectation & 18% Capping  
                <select id='select_manager_names'>
                <option value= "Aldo" > Aldo </option>
                <option value='Elsayed'>Elsayed</option>
                <option value='Ankit'>Ankit</option>
            </select>
        </span> </div>

        <div id='section2_chart'>

        </div>
              

                
            </div>

        </div>

        <div id='section3'>

        </div>


    </div>    
</div>
</body>

    <script>

formatValue2_digit = d3.format(".2s");
formatValue3_digit = d3.format(".3s");
function formatValue(d){
    if(d < 0){return formatValue2_digit(d)}
    if(d < 100){return d}
    if(d < 10000000){return formatValue2_digit(d)}
    else{return formatValue3_digit(d)}
}

var nodeWidth = (d) => d.getBBox().width;

var nodeHeight= (d) => d.getBBox().height;



 $("#fixed_operation_cost_Label").html( formatValue($('#fixed_operation_cost').val() ))
 $("#operation_cost_per_person_Label").html( formatValue($('#operation_cost_per_person').val() ))
 $("#EEEE_Volume_Target_Label").html( formatValue($('#EEEE_Volume_Target').val() ))

 $("#PropertyConsultant_Target_Label").html( formatValue($('#PropertyConsultant_Target').val() ))
 $("#SrPropertyConsultant_Target_Label").html(formatValue( $('#SrPropertyConsultant_Target').val() ))
 $("#LeasingConsultants_Target_Label").html( formatValue($('#LeasingConsultants_Target').val() ))

 $("#EEEE_Comission_Percentage_Range_Label").html( formatValue($('#EEEE_Comission_Percentage_Range').val() ))
 $("#NON_EEEE_Comission_Percentage_Range_Label").html( formatValue($('#NON_EEEE_Comission_Percentage_Range').val() ))
 $("#Staff_Comission_Percentage_Range_Label").html( formatValue($('#Staff_Comission_Percentage_Range').val() ))
 $("#Achievement_Percentage_Range_Label").html( formatValue($('#Achievement_Percentage_Range').val() ))

   





$("input").change(function(){
        $('#'+$(this).attr('id')+'_Label').html(formatValue($(this).val()))
      
       
      });


  
added_manager = 0
set_default_manager_value = false

$("#add_default_manager").click(function(){
    
    List_ManagerName =['Aldo','Elsayed','Ankit']
    List_Property_Consultants=[18,14,4]
    List_Sr_Property_Consultants=[13,4,0]
    List_Leasing_Consultants=[4,1,0]
    List_Expectation = [700000,300000,300000]
    List_Sales_type=[  "EEEE Balanced", "Non-EEEE Inclined", "EEEE Inclined"]
    no_managers = 3
    iter_manager = 0
    set_default_manager_value = true
    while(iter_manager < no_managers){
        MANAGER_ADD = List_ManagerName[iter_manager]
        PC_ADD = List_Property_Consultants[iter_manager]
        SrPC_ADD = List_Sr_Property_Consultants[iter_manager]
        LC_ADD = List_Leasing_Consultants[iter_manager]
        Expectation_ADD = List_Expectation[iter_manager]
        Sales_type_ADD= List_Sales_type[iter_manager]
        $("#add_manager").click();
       
        iter_manager = iter_manager+1
       
    }
    set_default_manager_value = false
    $("#add_default_manager").hide();
})


$("#add_manager").click(function(){


    var div = document.createElement("div");
    div.className ='manager_detail_class'
   

    var tag = document.createElement("span");
    var text = document.createTextNode("Manager Name");
    tag.appendChild(text);
    div.appendChild(tag);
    var Manager_name_input = document.createElement("input");
    Manager_name_input.id = "Manager_name_input_"+added_manager;
    if(set_default_manager_value){Manager_name_input.value = MANAGER_ADD }
    div.appendChild(Manager_name_input);

    var br = document.createElement("br");
    div.appendChild(br);

    var text = document.createTextNode(" Minimum Payout ");
    div.appendChild(text);
    var br = document.createElement("br");
    var Manager_name_input = document.createElement("input");
    Manager_name_input.id = "Manager_minimum_payout_"+added_manager;
    if(set_default_manager_value){Manager_name_input.value = Expectation_ADD }
    div.appendChild(Manager_name_input);

 
    

    var br = document.createElement("br");
    div.appendChild(br);

    var text = document.createTextNode(" Select Sales Type: ");
    div.appendChild(text);
    var br = document.createElement("br");
    div.appendChild(br);
    var sales_type = document.createElement('select');
    sales_type.id = "Manager_sales_type_"+added_manager;
   
    var option = document.createElement("option");
    option.value = "EEEE Balanced";
    option.text = "EEEE Balanced"
    sales_type.appendChild(option);

    var option = document.createElement("option");
    option.value = "EEEE Inclined";
    option.text = "EEEE Inclined"
    sales_type.appendChild(option);
  
    var option = document.createElement("option");
    option.value = "Non-EEEE Inclined";
    option.text = "Non-EEEE Inclined"
    sales_type.appendChild(option);
    div.appendChild(sales_type);

    var br = document.createElement("br");
    div.appendChild(br);
   

    var text = document.createTextNode("Property Consultant: ");
    div.appendChild(text);
   
    var headcount = document.createElement('input');
    headcount.id = "Property_consulatnt_HeadCount_"+added_manager;
    headcount.style.width = "50px"
    if(set_default_manager_value){headcount.value = PC_ADD }
    div.appendChild(headcount);


    var br = document.createElement("br");
    div.appendChild(br);
    var text = document.createTextNode("Sr.Property Consultant: ");
    div.appendChild(text);
   
    var headcount = document.createElement('input');
    headcount.id = "Sr_Property_consulatnt_HeadCount_"+added_manager;
    if(set_default_manager_value){headcount.value = SrPC_ADD }
    headcount.style.width = "50px"
    div.appendChild(headcount);

    var br = document.createElement("br");
    div.appendChild(br);
    var text = document.createTextNode("Leasing Consultant: ");
    div.appendChild(text);
    
    var headcount = document.createElement('input');
    headcount.id = "Leasing_consulatnt_HeadCount_"+added_manager;
    if(set_default_manager_value){headcount.value = LC_ADD }
    headcount.style.width = "50px"
    div.appendChild(headcount);

    var target_computation = document.createElement("div");
    target_computation.className ='target_computation'
    target_computation.id ='target_computation_'+added_manager;
    div.appendChild(target_computation);

    var element = document.getElementById("Manager_details_generate");
    element.appendChild(div);       


    if(set_default_manager_value){$("Manager_sales_type_"+added_manager).val(Sales_type_ADD) }
   added_manager = added_manager + 1
    



})


    </script>

    <script>

$("#simulate").click(function(){

    
    plan  = {'c1_p1':.03,'c2_p1':.06,'c3_p1':.08,'c4_p1':.10,'c1_p2':.02,'c2_p2':.03,'c3_p2':.04,'c4_p2':.05,'c1_p3':.02 ,'c2_p3':.03, 'c3_p3':.06}

    operation_cost_per_manager = $("#fixed_operation_cost").val()/added_manager;
    operation_cost_per_person = $("#operation_cost_per_person").val()

    Months_left = 12

    LeasingConsultants_Target =  $("#LeasingConsultants_Target").val()
    SrPropertyConsultant_Target = $("#SrPropertyConsultant_Target").val()
    PropertyConsultant_Target =  $("#PropertyConsultant_Target").val()


    manager_iter = 0

    EMAR_Volume_to_Sale_Range = []
    min_val = 2.5
    max_val = $("#EEEE_Comission_Percentage_Range").val()
    while(min_val < max_val){
        EMAR_Volume_to_Sale_Range.push(min_val)
        min_val = min_val + .5
    }
   
    Achievement_Percentage_Range = $("#Achievement_Percentage_Range").val()/100

    Non_EMAR_Volume_to_Sale_Range = []
    min_val = 2.5
    max_val = $("#NON_EEEE_Comission_Percentage_Range").val()
    while(min_val < max_val){
        Non_EMAR_Volume_to_Sale_Range.push(min_val)
        min_val = min_val + .5
    }

    Staff_Comission_Percentage_Range = []
    min_val = .55
    max_val = $("#Staff_Comission_Percentage_Range").val()/100
    while(min_val < max_val){
        Staff_Comission_Percentage_Range.push(min_val)
        min_val = min_val + .01
    }


  
    EMAR_Volume =  $("#EEEE_Volume_Target").val();
    EMAR_Volume_Split_Parts = 0

    manager_iter = 0
  
    consolidated_results = []
   

    while(manager_iter < added_manager){
        LeasingConsultants = $("#Leasing_consulatnt_HeadCount_"+manager_iter).val()
        PropertyConsultant = $("#Property_consulatnt_HeadCount_"+manager_iter).val()
        SrPropertyConsultant = $("#Sr_Property_consulatnt_HeadCount_"+manager_iter).val()
        Manager_name =  $("#Manager_name_input_"+manager_iter).val()
        Expectation = $( "#Manager_minimum_payout_"+manager_iter).val()
       
        Target = parseInt(LeasingConsultants) *  parseInt(LeasingConsultants_Target) +  parseInt(PropertyConsultant) *  parseInt(PropertyConsultant_Target) +  parseInt(SrPropertyConsultant_Target) *  parseInt(SrPropertyConsultant)
        Target = Months_left * Target

        head_count = parseInt(LeasingConsultants) + parseInt(PropertyConsultant) + parseInt(SrPropertyConsultant)
        operation_cost = operation_cost_per_manager + (parseInt(operation_cost_per_person)*parseInt(head_count)*parseInt(Months_left))

        sales_type = $("#Manager_sales_type_"+manager_iter).val() 
        if(sales_type == "EEEE Inclined"){
            EMAR_Target_Percentage_Simulation_Range = [.70,.80,.90,1.00]
          
        }
        if(sales_type == "Non-EEEE Inclined"){
            EMAR_Target_Percentage_Simulation_Range = [0,.10,.20,.30]
            
        }
        if(sales_type == "EEEE Balanced"){
            EMAR_Target_Percentage_Simulation_Range = [.40,.50,.60]
            
        }

        run_simulation = true
        start_target = Target
        while(run_simulation)
        {
        
           
        results = computeTarget(Manager_name,start_target,Target, operation_cost, EMAR_Target_Percentage_Simulation_Range, LeasingConsultants, PropertyConsultant, SrPropertyConsultant, Staff_Comission_Percentage_Range, Non_EMAR_Volume_to_Sale_Range, EMAR_Volume_to_Sale_Range ,Achievement_Percentage_Range,Expectation)
        if(results == "none")
        {
           break;
        }
        consolidated_results.push(results)
        run_simulation = check_results(results,Expectation)
     
        if(run_simulation){
            Target = Target + 1000000
        }
        }


        manager_iter= manager_iter+1
        


    }

    consolidated_results = consolidated_results.flat();

   
    var  axis={'sub_plot_dimension_1':'Manager_name', 'x_axis_column':'Achievement_per_TTL'  , 'y_axis_column': 'people_add_factor' ,'color_column': 'expectation_reached', 'text_column':'cap_bucket' }


    plt_data =[]
    sub_plot_x_domain = []
    k = d3.rollup(consolidated_results, v => { 
        sub_plot_x_domain.push(v[0][axis.sub_plot_dimension_1]) 
        return { } }  ,  d=>d[axis.sub_plot_dimension_1] )


    x_domain = []
    k = d3.rollup(consolidated_results, v => { 
        x_domain.push(v[0][axis.x_axis_column]) 
        return { } }  ,  d=>d[axis.x_axis_column] )

        y_domain = []
    k = d3.rollup(consolidated_results, v => { 
        y_domain.push(v[0][axis.y_axis_column]) 
        return { } }  ,  d=>d[axis.y_axis_column] )


   
    k = d3.rollup(consolidated_results, v => { 
      
       
    plt_data.push({
        'sub_plot_dimension_1': v[0][axis.sub_plot_dimension_1],
        'x_axis_column': v[0][axis.x_axis_column],
        'y_axis_column':  v[0][axis.y_axis_column],
        'color':    d3.sum(v,  d =>  {if(!d[axis.color_column]){  return 1} else{return 0} } ), 
        'text':    d3.sum(v,  d =>  {if(d[axis.text_column]!="green"){return 1}else{return 0} } )
        }) 
        return { } 
    }  ,  d=>d[axis.sub_plot_dimension_1],  d => d[axis.x_axis_column],d => d[axis.y_axis_column]  )

        axis['sub_plot_x_domain'] = sub_plot_x_domain;
 
    var dimension ={'subx' : x_domain.length, 'suby': y_domain.length }
   
    populate_heat_map("#section1_chart",dimension,plt_data, axis  );
    

    compute_stepped_increase();

})

function compute_stepped_increase(){
    manager_iter = 0

    while(manager_iter < added_manager){
        var LeasingConsultants = $("#Leasing_consulatnt_HeadCount_"+manager_iter).val() * parseInt(LeasingConsultants_Target)
        var PropertyConsultant = $("#Property_consulatnt_HeadCount_"+manager_iter).val() * parseInt(SrPropertyConsultant_Target) 
        var SrPropertyConsultant = $("#Sr_Property_consulatnt_HeadCount_"+manager_iter).val() * parseInt(PropertyConsultant_Target)
        var start = LeasingConsultants+PropertyConsultant+SrPropertyConsultant
        TTL = 12*(start + people_inc_factor[manager_iter]*(parseInt(LeasingConsultants_Target)+ 2*parseInt(SrPropertyConsultant_Target)  + 3*parseInt(PropertyConsultant_Target) ) )
        d = (TTL - 12*start)/66
        people_factor_per_month = d/( people_inc_factor*(parseInt(LeasingConsultants_Target)+ 2*parseInt(SrPropertyConsultant_Target)  + 3*parseInt(PropertyConsultant_Target) ))

    }   

}
function populate_heat_map(chart_id,dimension,data,axis){

d3.select(chart_id).selectAll("*").remove();


var sub_plots_x_column_name = axis.sub_plot_dimension_1; 
var y_axis_column = axis.x_axis_column; 
var x_axis_column = axis.y_axis_column; 

sub_plot_x_domain = axis.sub_plot_x_domain; 
 var sub_plot_width = (dimension.subx*40+50); 
 var sub_plot_heght= (dimension.suby*20+50)+400; 
 var margin = {top: 80, right: 25, bottom: 30, left: 40},
 width = (sub_plot_width*sub_plot_x_domain.length) - margin.left - margin.right,
 height = sub_plot_heght - margin.top - margin.bottom-20;


var top_svg = d3.select(chart_id).append("div").append("svg").attr("width", 1400 ).attr("height", 80 ).attr("transform", "translate("+0+", 0)").append("g")
var svg= d3.select(chart_id).append("div").attr("class",'custom-scroll').style('height',height+30).append("div").attr("class",'anti-dir').append("svg").attr("width", width ).attr("height", (height) ).append("g");

sub_plot_x_scale = d3.scaleBand().domain(sub_plot_x_domain).range([margin.left,width - margin.right]);
const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])
var color_legend = top_svg.append("g")



color_legend.append("text").attr("x",170).attr("y",10).text("#simulations failed")
color_legend.append("text").attr("x",170).attr("y",25).text("too meet Manager Expectation")
color_legend.append("circle").attr("cx",315).attr("cy",15).attr("r",10).attr("fill","#5d8700")
color_legend.append("text").attr("x",315).attr("y",19).attr("text-anchor","middle").text("0")
i = 0
string_val = " simulation"
while(i < 10){var clr = "white";
if(i < 3){clr = "black"}
color_legend.append("circle").attr("cx",(i+1)*20+315).attr("cy",15).attr("r",10).attr("fill",myColor(i))
color_legend.append("text").attr("x",(i+1)*20+315).attr("y",19).attr("text-anchor","middle").text(i+1).attr("fill", clr )
i = i+1
}

color_legend.attr("transform", function() {return ( "translate(" + (1300 - nodeWidth(this))/2 + ",10)"  )});





//subplot_x_text =    //subplot_x_text.attr('transform', function() {return `translate(${(1400 - nodeWidth(this)) / 2},${25})`});


show_xaxis = true
show_yaxis = true
results_computing_manageriter = 0

var data = d3.group(data, d => d.sub_plot_dimension_1)

        sub_plot_x_domain.forEach(
            
            sub_x_domain => {
            
                  
                    consider_data = data.get(sub_x_domain)
                   var working_svg = svg.append("g").attr("transform", "translate("+sub_plot_x_scale(sub_x_domain)+", 0)")
                //var axis_working = axissvg.append("g").attr("transform", "translate("+sub_plot_x_scale(sub_x_domain)+", 0)")

         
                HeatMap(consider_data,working_svg,(sub_plot_width-70) ,(sub_plot_heght-70)-100,sub_x_domain,true, true)

                }
            );
            
            
        
            
            
        


}

function HeatMap(data,svg,width,height,sub_x_domain, show_yaxis, show_xaxis){

    res_comp = []
    k = d3.rollup(data,v=>{
        res_comp.push({
            'people_inc_factor': v[0].y_axis_column,
            'Achievement': Math.round((parseFloat(d3.max(v,d=> { if(d.color > 0){return parseFloat(d.x_axis_column)}  }) )+ parseFloat(.1)))/100,

        })
        return{}
    }, d=> d.y_axis_column)
    console.log("&&&")
    console.log(res_comp)


 





    results_computing_manageriter = results_computing_manageriter + 1
chart_margin = 0; if(show_yaxis){chart_margin = 30;}
data.sort(function(a, b) { return d3.ascending(a.x_axis_column, b.x_axis_column)}); 
const myGroups = Array.from(new Set(data.map(d => d.x_axis_column)))
data.sort(function(a, b) { return d3.ascending(a.y_axis_column  , b.y_axis_column)}); 
const myVars = Array.from(new Set(data.map(d => d.y_axis_column)))



height = height -30
const x = d3.scaleBand().range([ width,chart_margin ]).domain(myGroups).padding(0.02); 
var borderPath = svg.append("g").append("rect").attr("x", chart_margin).attr("y", 0).attr("height", 30).attr("width", (width-chart_margin ))
.attr("stroke", "white").attr("stroke-width", "3px").attr("fill","#8a5f3a");
var text = svg.append("g").append("text").attr("x", width/2).attr("y", 20).attr("text-anchor","middle").text(sub_x_domain).attr("font-size","14px");

var working_space= svg.append("g").attr("transform", `translate(0,30)`)
if(show_xaxis){working_space.append("g").style("font-size", 12).attr("transform", `translate(0, `+(height)+`)`).call(d3.axisBottom(x).tickSize(0).tickFormat( d3.format('.0%') )).select(".domain").remove()};

const y = d3.scaleBand().range([ height,0 ]).domain(myVars).padding(0.05);
if(show_yaxis){
working_space.append("g").style("font-size", 12).attr("transform", `translate( `+chart_margin+`,0)`).call(d3.axisLeft(y).tickSize(0)).select(".domain").remove()
yaxis_label = working_space.append("text").text("Staff commission %").attr("stroke","#aaa").attr("text-anchor", "middle").attr("x", height/2+20).attr("y",-10).attr("transform", "rotate(-90)")
// yaxis_label.attr('x', function() {return (-1* nodeHeight(this)/2 ) });
}

const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])

var i = 0
working_space.append("g").selectAll().data(data, function(d) {return d.x_axis_column+':'+d.y_axis_column;})
.join("rect").attr("x", function(d) { return x(d.x_axis_column) }).attr("y", function(d) { return y(d.y_axis_column) }).attr("width", x.bandwidth() ).attr("height", y.bandwidth() )
.style("fill", function(d) {  if(d.color==0){return "#5d8700"} return myColor(Math.min(+d.color,10))    } ).style("stroke-width", 4).style("stroke", "none").style("opacity", 0.8).on("click",function(event,d){

    

   $('#scenario_1_manager').html(sub_x_domain)
   $('#scenario_1_achievement').html( d.y_axis_column )
   
   $('#scenario_1_staff_increase_factor').html(d.x_axis_column)
   
            
                


    populate_table_scenario_table_section_1(d.x_axis_column,d.y_axis_column,sub_x_domain )

})
 
 
    working_space.append("g").selectAll().data(data, function(d) {return d.x_axis_column+':'+d.y_axis_column;})
.join("text").attr("x", function(d) { return x(d.x_axis_column)+ (x.bandwidth()-nodeWidth(this))/2   }).attr("y", function(d) { return y(d.y_axis_column)+y.bandwidth()/2 }).text(d=>d.text)


}


function check_results(results,Expectation){
    return_val = true
    var cmin = d3.min(d3.map(results, e => e['cap']))
    var cmax = d3.max(d3.map(results, e => e['cap']))
   
    var expect = d3.min(d3.map(results, e => e['Manager_payout']))
    if(cmin > 0 ){
       
        if(cmax <= .18){
            
            if(parseInt(Expectation) <= parseInt(expect))
            { 
            return_val = false
            }
        }
    }
    return return_val
}


function computeTarget(Manager_name,start_target, TARGET, operation_cost, EMAR_Target_Percentage_Simulation_Range, LeasingConsultants, PropertyConsultant, SrPropertyConsultant, Staff_Comission_Percentage_Range, Non_EMAR_Volume_to_Sale_Range, EMAR_Volume_to_Sale_Range ,Achievement_Percentage_Range,Expectation){

    All_results_per_Target =  []
   
    var people_add_factor = -1
    if(start_target < TARGET){
            target_difference = parseInt(TARGET) - parseInt(start_target)
            var people_add_factor =  target_difference/ (parseInt(LeasingConsultants_Target) + 2 *parseInt(SrPropertyConsultant_Target) + 3* parseInt(PropertyConsultant_Target))
            
        }
        if(people_add_factor > 30){
            return "none"
        }

        people_add_factor = Math.ceil(parseInt(people_add_factor))

        emar_achievement_per_start = .5
        non_emar_achievement_per_start = .5
while(emar_achievement_per_start <= Achievement_Percentage_Range){
    var EMAR_ACHIEVEMENT_PER = emar_achievement_per_start
   
    emar_achievement_per_start = emar_achievement_per_start + .5
    
    non_emar_achievement_per_start = .5
    while(non_emar_achievement_per_start <= Achievement_Percentage_Range){
        var NON_EMAR_ACHIEVEMENT_PER = non_emar_achievement_per_start
        non_emar_achievement_per_start = non_emar_achievement_per_start + .5

    for(etp in EMAR_Target_Percentage_Simulation_Range){
        var EMAR_Target_Percentage = EMAR_Target_Percentage_Simulation_Range[etp]
        var EMAR_Target = parseInt(Target) * parseFloat(EMAR_Target_Percentage)
        var EMAR_ACHIVEMENT = EMAR_ACHIEVEMENT_PER * EMAR_Target
       var  NON_EMAR_Target = parseInt(Target) - parseInt(EMAR_Target)
       var NON_EMAR_ACHIVEMENT = NON_EMAR_ACHIEVEMENT_PER * NON_EMAR_Target
       var TTL_ACHIEVEMENT = NON_EMAR_ACHIVEMENT + EMAR_ACHIVEMENT

        for(scp in Staff_Comission_Percentage_Range){
            Staff_Commission_Percentage = Staff_Comission_Percentage_Range[scp]

            var Staff_EMAR_Payout = EMAR_ACHIVEMENT * Staff_Commission_Percentage
            var Staff_NON_EMAR_Payout = NON_EMAR_ACHIVEMENT * Staff_Commission_Percentage
            var Staff_PAYOUT = Staff_NON_EMAR_Payout + Staff_EMAR_Payout
            var NET_EMAR = EMAR_ACHIVEMENT - Staff_EMAR_Payout
            var NET_NON_EMAR = NON_EMAR_ACHIVEMENT - Staff_NON_EMAR_Payout


            var slab1 = 0;
            var slab2 = 0;
            var slab3=0;
            var slab4=0
        
                var MANAGER_EMAR_PAYOUT = 0;slab1 = 0;slab2 = 0;slab3=0;slab4=0
                if(EMAR_ACHIEVEMENT_PER >= 1){
                    slab1 =  Math.min(1,EMAR_ACHIEVEMENT_PER)*plan['c1_p1']*(1-Staff_Commission_Percentage)
                    slab2 =  Math.max(Math.min(.5, EMAR_ACHIEVEMENT_PER-1),0)*plan['c2_p1']*(1-Staff_Commission_Percentage)
                    slab3 =  Math.max(Math.min(.5, EMAR_ACHIEVEMENT_PER-1),0)*plan['c3_p1']*(1-Staff_Commission_Percentage)
                    slab4 =  Math.max(EMAR_ACHIEVEMENT_PER-2,0)*plan['c4_p1']*(1-Staff_Commission_Percentage)
                }   
                else if(EMAR_ACHIEVEMENT_PER >= .85){
                    slab1 =  Math.min(1,EMAR_ACHIEVEMENT_PER)*plan['c1_p2']*(1-Staff_Commission_Percentage)
                }
                var MANAGER_EMAR_PAYOUT =  (slab1+slab2+slab3+slab4)*EMAR_Target

                var MANAGER_NON_EMAR_PAYOUT = 0;slab1 = 0;slab2 = 0;slab3=0;slab4=0

                if(NON_EMAR_ACHIEVEMENT_PER >= .85){
            slab1 =  Math.min(1,NON_EMAR_ACHIEVEMENT_PER)*plan['c1_p2']*(1-Staff_Commission_Percentage)
            slab2 =  Math.max(Math.min(.5, NON_EMAR_ACHIEVEMENT_PER-1),0)*plan['c2_p2']*(1-Staff_Commission_Percentage)
            slab3 =  Math.max(Math.min(.5, NON_EMAR_ACHIEVEMENT_PER-1),0)*plan['c3_p2']*(1-Staff_Commission_Percentage)
            slab4 =  Math.max(NON_EMAR_ACHIEVEMENT_PER-2,0)*plan['c4_p2']*(1-Staff_Commission_Percentage)
        }
            
        var MANAGER_NON_EMAR_PAYOUT =  (slab1+slab2+slab3+slab4)*NON_EMAR_Target
        
        var MANAGER_PAYOUT = MANAGER_NON_EMAR_PAYOUT + MANAGER_EMAR_PAYOUT
    
        expectation_reached = MANAGER_PAYOUT >= Expectation
        NET_REMAINED = TTL_ACHIEVEMENT -Staff_PAYOUT -MANAGER_PAYOUT
        
        GM_ACHIEVEMENT_PERCENTAGE = TTL_ACHIEVEMENT/(TARGET*.8)
        
        if(GM_ACHIEVEMENT_PERCENTAGE >= 2){
            GENERAL_MANAGER_PAYOUT = NET_REMAINED * plan['c3_p3']
        }
        else if( GM_ACHIEVEMENT_PERCENTAGE >= 1.25){
            GENERAL_MANAGER_PAYOUT = NET_REMAINED * plan['c2_p3']
        }
        else if( GM_ACHIEVEMENT_PERCENTAGE >= 1){
            GENERAL_MANAGER_PAYOUT = NET_REMAINED * plan['c1_p3']
        }
        else{
            GENERAL_MANAGER_PAYOUT = 0
        }

        
        NET_PROFIT = NET_REMAINED - GENERAL_MANAGER_PAYOUT - operation_cost
        
    
        if(NET_PROFIT<=0){
            cap = -.05
            cap_bucket = 'gray'
            
        }
            
        else{
            cap = (GENERAL_MANAGER_PAYOUT + MANAGER_PAYOUT)/NET_PROFIT
            cap = parseFloat(cap.toFixed(2))
            if(cap < 0){
                cap = -.05
                cap_bucket = 'gray'}
            else if(cap <= .18){  
                cap_bucket ='green'
            } 
            else{ 
                cap_bucket ='red'}

               if(cap > .4){  
                cap = .4
            } 
        }
    
        isGMGM =  GENERAL_MANAGER_PAYOUT > MANAGER_PAYOUT
    
   

    result = {'Manager_name':Manager_name,'TARGET':Target, 'expectation_reached':expectation_reached,
    'Achievement_TTL':TTL_ACHIEVEMENT,  'emar_target_percentage':EMAR_Target_Percentage,
    'EMAAR_Target': EMAR_Target,'NON_EMAAR_Target': NON_EMAR_Target,
    'emar_achievement_percent':EMAR_ACHIEVEMENT_PER,
    'non_emar_achievement_percent':NON_EMAR_ACHIEVEMENT_PER, 
    'GM_TARGET':Target*.8,'Staff_comission_percentage':Staff_Commission_Percentage, 'Agent_Payout':Staff_PAYOUT,
     'Manager_payout':MANAGER_PAYOUT,
     'General_Manager_Payout':GENERAL_MANAGER_PAYOUT,
     'cap_bucket':cap_bucket,'cap':cap.toFixed(2) , 
     'operation_cost':operation_cost  ,'Net_Profit':NET_PROFIT ,'isGMGM':isGMGM  , 'people_add_factor': people_add_factor,
    'Achievement_per_TTL': Math.round((TTL_ACHIEVEMENT/Target) * 10) / 10

    
    } 
     All_results_per_Target.push(result)
    
    }

   

}
}

    }

   // , Non_EMAR_Volume_to_Sale_Range, EMAR_Volume_to_Sale_Range

   return All_results_per_Target

    }


    </script>

    <script>
start_script_senario_table_1 = 0
function populate_table_scenario_table_section_1(f_Achievement_per_TTL,f_people_add_factor,f_Manager ){
   
/*    'Manager_name':Manager_name,'TARGET':Target, 'expectation_reached':expectation_reached,
    'Achievement_TTL':TTL_ACHIEVEMENT,  'emar_target_percentage':EMAR_Target_Percentage,
    'EMAAR_Target': EMAR_Target,'NON_EMAAR_Target': NON_EMAR_Target,
    'emar_achievement_percent':EMAR_ACHIEVEMENT_PER,
    'non_emar_achievement_percent':NON_EMAR_ACHIEVEMENT_PER, 
    'GM_TARGET':Target*.8,'Staff_comission_percentage':Staff_Commission_Percentage, 'Agent_Payout':Staff_PAYOUT,
     'Manager_payout':MANAGER_PAYOUT,
     'General_Manager_Payout':GENERAL_MANAGER_PAYOUT,
     'cap_bucket':cap_bucket,'cap':cap.toFixed(2) , 
     'operation_cost':operation_cost  ,'Net_Profit':NET_PROFIT ,'isGMGM':isGMGM  , 'people_add_factor': people_add_factor,
    'Achievement_per_TTL': Math.round((TTL_ACHIEVEMENT/Target) * 10) / 10

    */


    if(start_script_senario_table_1 == 1){
   
   
    start_script_senario_table_1 = 0
    }



var dataSet = []
var sort_data = []
i = 0


   set_target = true
consolidated_results.map(d => {
 if(parseFloat(d.Achievement_per_TTL) == parseFloat(f_Achievement_per_TTL) ){
     
     if(parseFloat(d.people_add_factor)==parseFloat(f_people_add_factor)){
        if(d.Manager_name==f_Manager){
            if(set_target){
            $('#scenario_1_staff_Target').html( formatValue(d.TARGET) )
            set_target = false
        }
      dataSet.push([
           d.operation_cost,
          d.TARGET,
            d.EMAAR_Target,  d.NON_EMAAR_Target,
      Math.round(d.emar_achievement_percent*100),Math.round(d.non_emar_achievement_percent*100), 
       d.Achievement_TTL ,
        Math.round(d.Staff_comission_percentage*100),
       d.Manager_payout, 
       d.General_Manager_Payout,
       Math.round(d.cap*100,2) ,
       d.cap_bucket ])
       
     
    i = i+1

      
           
        }
     }
    }
 });
 
 /*
 sceanriotable_section_1 = $('#scenario_table_section_1').DataTable( {
        data: dataSet,
        'data-order' : sort_data,
        columns: [
        { title: "Operational Cost" },
           { title: "TARGET" },
            { title: "EEEE-TARGET" },
            { title: "NON-EEEE-TARGET" },
            { title: "EEEE Achievement %" },
            { title: "NON-EEEE Achievement % " },
            { title: "Total Achievement" },
            { title: "Staff commission%" },
           
            { title: "Manager Payout" },
            { title: "General Manager Payout" },
            { title: "Capping%" },
            { title: "Net_Profit" }
        ],iDisplayLength: -1
    } );
    */


var sceanriotable_section_1 = $('#scenario_table_section_1').DataTable(
            {"destroy": true,"responsive": true, "iDisplayLength": -1, "bProcessing": true,"bDeferRender": true,
"paging": true,"aaData": dataSet, "aoColumns": [
        { title: "Operational Cost" },
           { title: "TARGET" },
            { title: "EEEE-TARGET" },
            { title: "NON-EEEE-TARGET" },
            { title: "EEEE Achievement %" },
            { title: "NON-EEEE Achievement % " },
            { title: "Total Achievement" },
            { title: "Staff commission%" },
           
            { title: "Manager Payout" },
            { title: "General Manager Payout" },
            { title: "Capping%" },
            { title: "Net_Profit" }
        ],
"columnDefs": [
{
    "render": function ( data, type, row ) {
                    return formatValue(data);
                },
                "targets": [0,1,2,3,6,8,9]}
   
 /*else{
      "createdCell": function (td, cellData, rowData, row, col) {
   //  $(td).attr("data-order", cellData);
    
   "render": function ( data, type, row ) {
                    return data +' ('+ row[3]+')';
                },
                "targets": 0
                
            $(td).html( formatValue(cellData) );  
            $(td).attr("data-sort", cellData);
           
       $(td).html("<span style=\"color:red\">( " + Math.abs(cellData).format(2,3,',','.') + " )</span>"); 
    }*/
    
]})

    start_script_senario_table_1 = 1
// d3.select("#failed_scenarios").html(html_string);



//'Agent_emar_payout':,'Agent_non_emar_payout':  ,'Manager_payout':,'General_Manager_Payout':,'Net_Profit'



}


$("#select_manager_names").change(function(){

    populate_bar_achievement_chart("#section2_chart")
});


function populate_bar_achievement_chart(id, data,axis){

}
    </script>
</html>