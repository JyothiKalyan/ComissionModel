

<html>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  
  
  <link href=https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css rel=stylesheet>
  
  <!--<table data-sort-name=stargazers_count data-sort-order=desc  -->
    <script src=https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js></script>






    <style>


.custom-scroll{
    position:relative;
    /*direction:rtl;*/
    overflow-y: scroll;
    position: relative;
    margin-bottom: 100px;
    display: inline-block;
    float: left;
    width: 100%;
    overflow-x: scroll;
    background-color:rgb(238 238 238);
    

}

thead, tbody tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }
        
.anti-dir{
    position:relative;
   /*direction:ltr*/
    
}

.Insights_title{
    color:white;
    font-size: 30px;
    background-color: black;
   
    padding-top:30px;
    text-align: center;
    font-family: 'Montserrat', sans-serif;
   
}

        .reversedRange {
  direction: rtl
}
        .plan_table{
            position:relative;
            width:30%;
            top:20px;
            display:inline;
            float:left;
            padding-left:20px;
        }
       .ttl_target_group{
           background-color:rgb(120, 188, 233)
           
       }
      .horizontal_line{
        clear:both;
        height:2px; 
        margin-top:8px;margin-bottom:8px; 
        position:relative;
        margin-left:50px;margin-right:50px;
        background-color: black;
      }
      
        
        .yaxis{
          font-size: 14px;
          font-weight:bold;
          font-family: 'Montserrat', sans-serif;
        }
        
        .chart-title{
          font-size: 25px;
         
       
          font-family: 'Open Sans', sans-serif;
        }
        .xaxis{
          font-size: 14px;
          font-family: 'Montserrat', sans-serif;
        }

        .section-title{
            clear:both;
            font-family: 'Open Sans', sans-serif;
            font-size:24px;
            
            position:relative;
            float: left;
            display: inline;
            text-align:center;
           
            font-weight:bold;
            
        }

        .chart_title{
            clear:both;
            font-family: 'Open Sans', sans-serif;
            font-size:24px;
            text-align:center;
            font-weight: bold;
            padding-bottom:10px;
            background-color: #d1d1d1;
        }
        .chart_sub_title{
            font-size:14px;
            font-family: 'Open Sans', sans-serif;
            text-align:center;
            color:blue;
            background-color: #d1d1d1;
        }

        .subplot_axis_label{
    background-color: white;
}

        br {
   display: block;
   margin: 30px 0;
}
        .section-explaination{
    position:relative;
    width:70%;
    font-size:20px;
    padding-left:15%;
    font-family: 'Raleway', sans-serif
}
.halfsize {
   position:relative;
   width:80%;
   height:300px;
}

.small-text{
    font-size:12px;
    top:0px;
    position:relative;
}

.text_labels{
    pointer-events: none;
}

.page-title{
    position:relative;
    z-index:100;
    color:white;
    font-size:35;
    background-color: black;
    text-align: center;
}

.highlite_number{
    font-size:30;
    font-family: 'Open Sans', sans-serif;
           
}

.highlite_text{
    font-size:24px;
    color:burlywood;
    font-weight: bold;

}

.si{
    position: relative;
    display: inline;
    width: 200px !important;
}
.inputs{
    position: relative;
    padding-left:30px;
    padding-top:50px;
}
.input_box_span{
    position: relative;
    display: inline;
    float: left;
    width: 200px;
    margin-left:100px;
}

.vertical_scroll{
    position: relative;
    overflow-y: scroll;
    width:100%;
    height:500px;
}

.horizontal_scroll_2{
    position: relative;
    overflow-x: scroll;
    display: inline; 
    float: left;
    width:1200px;
    background-color:rgb(237 237 237);

}

.horizontal_scroll_3{
    position: relative;
    overflow-x: scroll;
    display: inline; 
    float: left;
    width:1200px;
    background-color:rgb(237 237 237);

}


.horizontal_scroll{
    position: relative;
    overflow-x: scroll;
    display: inline; 
    float: left;
    width:1320px;
    background-color:rgb(237 237 237);
}
.horizontal_scroll_side_div{
    float: left;
    width:80px;
    display: inline;
    position: relative;
    background-color:rgb(237 237 237);

}
.tooltip{
    background-color: black;
    font-size: 10px;
    color:white;
    font-family: 'Open Sans', sans-serif;
    padding:10px;
    width:300px;
    pointer-events: none;
}

.white_axis line{
  stroke: rgb(65, 104, 155);
}

.white_axis path{
  stroke: rgb(65, 104, 155);
}

.white_axis text{
  fill: rgb(255, 255, 255);
  font-size:18px;
  font-weight:bold;
}

.white_axis_x line{
  stroke: rgb(65, 104, 155);
}

.white_axis_x path{
  stroke: rgb(65, 104, 155);
}
.white_axis_x text{
    fill: rgb(255, 255, 255);


  
}

.red_axis line{
    stroke: red

}

.red_axis path{
  stroke: red
}
.red_axis text{
    fill: red;
    font-family: 'Open Sans';
    font-weight: 100px;


  
}

.chart_description{
    clear:both;
    color:red;
    font-size: 14px;
    text-align:center;
   
}

.scrollable-element {
  scrollbar-color: cornflowerblue rgb(237 237 237);
}

        </style>


<script src="https://d3js.org/d3.v6.min.js"></script>

<body style='width:1400px;margin: auto;position: absolute;'>
<div>
    <div >
        
        <div class='page-title'>  WHAT SHOULD TARGET BE ?? <br>
            <span style='font-size:20px'>For a given operation cost so that capx is <= 18</span>
        </div>
        <div style='padding-left:50px;padding-right:50px'> 
        <div class='inputs' style='padding-left:150px'>
            <div>
        <span class='section-title'> Factors which are known</span> 
        <span class ='input_box_span' > Operation Cost: <input type="range" min="500000" max="5000000" value="2600000" step='50000' class="slider si" id="operational_cost" > <label id='operational_cost_label'>2,600,000</label> </span>
        <span class ='input_box_span'> %EEEE Target: <input type="range" min="1" max="100" value="20" step='1' class="slider si" id="emar_target_percentage" > <label id='emar_target_percentage_label'>20</label> %</span> <br>
        </div>
        <div style='clear:both;padding-top:20px'>
            <span class='section-title'> Factors which in Control</span> 
        <span class ='input_box_span' >  Staff Comission: <input type="range" min="55" max="100" value="63" step='1' class="slider si" id="agent_comission">  <label id='agent_comission_label'>63</label>% </span>
        <span class ='input_box_span' >  General Manager Target Factor:<input type="range" style='width:50px'  min="0" max='100' class="slider si reversedRange" step="1" value="20" id="gm_target_factor_inv">  <span id='gm_target_factor_label' > 80</span>% <label id='gm_target_factor_inv_label' style='display:none'></label></span> 
        
        

        <div style='clear:both;padding-top:20px'>
                <table class='plan_table' >
                    <th>PLAN-1 (EEEE, Target_Achieved)</th> 
                    <tr><td><85%</td><td> 0 </td></tr>
                    <tr><td>85% -100%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c1_p1"></td></tr>
                    <tr><td>100% -150%</td><td><input style='width:50px' type="number" min="0"  step="1" value="6" id="cap_c2_p1"></td></tr>
                    <tr><td>150% -200%</td><td><input style='width:50px' type="number" min="0"  step="1" value="8" id="cap_c3_p1"></td></tr>
                    <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="10" id="cap_c4_p1"></td></tr>
                </table>
        
                <table class='plan_table' > 
                <th>PLAN-2 (Manager-all Other)</th>
                <tr><td><85%</td><td> 0 </td></tr>
                <tr><td>85% -100%</td><td><input style='width:50px' type="number" min="0"  step="1" value="2" id="cap_c1_p2"></td></tr>
                <tr><td>100% -150%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c2_p2"></td></tr>
                <tr><td>150% -200%</td><td><input style='width:50px' type="number" min="0"  step="1" value="4" id="cap_c3_p2"></td></tr>
                <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="5" id="cap_c4_p2"></td></tr>
            </table>
        
                <table class='plan_table'> 
                    <th> PLAN-3 (General Manager) </th>
                <tr><td><85%</td><td>0</td></tr>
                <tr><td>85% -100%</td><td><input style='width:50px' type="number" min="0"  step="1" value="2" id="cap_c1_p3"></td></tr>
                <tr><td>100% -150%</td><td><input style='width:50px' type="number" min="0"  step="1" value="3" id="cap_c2_p3"></td></tr>
                <tr><td>200+%</td><td><input style='width:50px' type="number" min="0"  step="1" value="6" id="cap_c3_p3"></td></tr>
            </table>
        </div>
    </div>
    


        <div></div>
        <div style='clear:both;position: relative;padding-top:60px' class='simulation_parameters'>
            <span class='section-title'> Factors which are Futuristic & are not in control</span> <br>
            <div style='clear:both;padding-left:300px'>
            <span  class ='input_box_span'> EEEE Achievement Percentage: <input type="range" min="50" max="800" value="400" step='1' class="slider si" id="emar_achievement_percentage" > <label id='emar_achievement_percentage_label'>400</label>% </span> 
            <span class ='input_box_span'> NON-EEEE Achievement Percentage: <input type="range" min="50" max="800" value="400" step='1' class="slider si" id="non_emar_achievement_percentage" > <label id='non_emar_achievement_percentage_label'>400</label>% </span> 
            </div>
        
        </div>
        </div>


    <div>
        <div style='clear:both'></div>
        <br>
        <button id='simulate_start' style='position:relative;left:40%' type="button" class="btn btn-primary">What should target be?</button>
        <div id='simulate_update' style='position:relative;left:40%;text-allign:center;padding-top:50px'> </div>
    </div>
    <div>
        
        
        </div>

        <div style='clear:both;position: relative;top:30px;display: none;' class='results_box'>
            For this given combination, minimum TTL_Target for Managers should be  <span id='Target_result' class='highlite_number'> </span> <br>
            For this given combination, minimum TTL_Target for General Managers should be  <span id='GM_Target_result' class='highlite_number'> </span> <br>
            Min Net Profit  <span id='Min_Net_Profit' class='highlite_number'> </span> <br>
            Max Net Profit  <span id='Max_Net_Profit' class='highlite_number'> </span> <br>
        
        </div>

       

    </div>

  <div>
      
    <div class='analyzing_results' style=' position:relative,width:100%;text-align: center;padding-top:20px;font-size: 20px;font-family: "Montserrat", sans-serif;padding-bottom:10px ;background-image: linear-gradient(#c7d875, #8c9c35);'>
        
        
        from Analyzing  <span id='no_targets_analyzed' style='font-size:46px'></span> simulations<br>

        The algorithm recommends to set target at <span id='target_computed' style='font-size:56px' ></span> with staff comission as <span style='font-size:56px' id='staff_comission_coomputed'></span>

    </div>


    <div id='section_1' style='clear:both'>
        <div  class='Insights_title' style='padding-bottom:40px'>
           &#10004 Target influences  Manager & General Manger payout. 
        </div>
        <div  style='background-color:#eee;'>
            <div class='chart_title'>  Higher Targets have low avg.capx   <span class='chart_sub_title'> so, the targets should be minimum possible adhering to capx 18%</span></div>
           
            <div class='chart_description'> *Distribution of Capx within target</div>
            <div id='Target_Capx_Achievement_Violin'></div>
            
        </div>
       
    </div>



    <div id='section_2' style='clear:both'>

        <div  class='Insights_title' style='padding-bottom:40px'>

            &#10004 Staff comission should be minimum possible to to keep capx in control 
        </div>
        <div style='background-color:#eee;'>
            <div  class='chart_title'> <span id='section_2_ct'> For a given target, higher agent comission have lower adherence to capx 18% </span> 
                 <span id='section_2_st'  class='chart_sub_title'> so, the staff comission should be minimum </span> </div>
            <div class='chart_description' style='padding-bottom:5px'> *Distribution of <span id='metric_select_chart'>Capx</span> along staff comission within target</div>
            <div>
                <div style='position:relative;display: inline;width:30px;float:left;'> 
                
                    

                    <select  id="section_2_metric" style='transform: rotate(-90deg);top: 162px;left: -20px;position: relative;'>
                        <option value="capx">CapX</option>
                        <option value="np">NetProfit</option>
                       
                      </select>

                </div>
                <div  style='position:relative;display: inline;width:1370px;float:left;' ><div id='StaffPercentage_chart'></div>
            </div>
        </div>
        <div id='scenario'  style='clear:both'>
            <table id='scenario_table'>
            
            </table>
        </div>
        </div>
        </div>



    <div id='section_3' style='clear:both'>
        <div  class='Insights_title' style='padding-bottom:40px'>

          &#10004 It is tough to achieve higher achievement% for higher targets  <br>
          &#10004 So, targets can be further reduced by trading-off with achievement% with target
        </div>
        <div  style='background-color:#eee;'>
            <div class='chart_title'> Achievements High %Target is a rare scenario which occurs with high target & high achievement %<br>
                <span class='chart_sub_title'> Practically, %achievement scale inversly with target. so, identifying most common TTL Achievement </span> </div>  
                <div class='chart_description' >  
                    Probability & Cumulative Probability of occurance of Achiement 
                    </div> 
                
<div style='position:relative;width:100%'>
    <div style='position:relative;left:40%'>
                    <span  style='clear:both;color:black;font-size:8px;float:left;position:relative'>  <input type="range" min="10" max="150" value="20" step='2' style='display:inline;float:left;position:relative;width:100px'  id="bins" > 
                        <span style='float:left;position:relative' id='bins_label'>20</span> bins </span>
                    </div>
                    </div>
           
           <div style='clear:both'></div>
            <div id='Actual_Achieved_byCapx' ></div>
        </div>
            
       
    </div>

    <div id='section_4' class='analyzing_results' style=' color:white;clear:both;position:relative;width:100%;text-align: center;padding-top:20px;font-size: 20px;font-family: "Montserrat", sans-serif;padding-bottom:10px ; background-image: linear-gradient(  #ddc9b8, #4e2b0d  );'> 
        
Filtering for Achievemnet% for which maximum Achievement is less than <span id='achievement_filter_value' style='font-size:25px'></span> 
    </div>


    <div id='section_5' style='clear:both'>

        <div id='HeatMapSubPlot'>

        </div>
    </div>








    </div>











  </div>

  <div style='clear:both'>
    <div>
    Comparing plans
</div>
<div id='comapring_space'>

</div>
<div id='add_scenario'>
    +Add Scenario to compare
</div>
</div>


</div>


</body>
<script>
    added_plan = 0
$("#add_scenario").click(function(){

    var div = document.createElement("div");

    var tag = document.createElement("span");
    tag.className = "delete_plan";
   var text = document.createTextNode("-");
   tag.appendChild(text);
   div.appendChild(tag);
  

    var input = document.createElement("input");
    input.type = "number";
   

   var tag = document.createElement("span");
   var text = document.createTextNode("Target");
   tag.appendChild(text);
   div.appendChild(tag);
    div.appendChild(input);
   

    var tag = document.createElement("span");
   var text = document.createTextNode("Staff Comission");
   tag.appendChild(text);
   div.appendChild(tag);
    var input2 = document.createElement("input");
    input2.type = "number";
    div.appendChild(input2);


   var element = document.getElementById("comapring_space");
   element.appendChild(div);


    added_plan = added_plan + 1
})

function draw_mixed_plot(chart_id,data,axis,metric){


    var margin = {top: 10, right: 30, bottom: 30, left: 40}, 
    chart_width = (80*metric) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;


  
    d3.select(chart_id).selectAll("*").remove();
    metric = parseInt(metric)
    var factor = (axis.achievemed_max - axis.achievemed_min)/metric
 

        var plot_data2 = [] 
    var k = d3.rollup(data, v => { plot_data2.push({
        'Achieved_bkt': Math.round((v[0].Achievement_TTL-axis.achievemed_min)/factor ),
         'min_Achieved':Math.round((v[0].Achievement_TTL-axis.achievemed_min)/factor )*factor,
         'max_Achieved':(1+Math.round((v[0].Achievement_TTL-axis.achievemed_min)/factor ))*factor, 
         'cnt':d3.sum(v,  d =>  { ;return 1} ),
         'cnt_green':d3.sum(v,  d =>  { if(d.cap_bucket == 'green'){return 1} return 0} ),
         'cnt_gray':d3.sum(v,  d =>  { if(d.cap_bucket == 'gray'){return 1} return 0} ),
         'cnt_red':d3.sum(v,  d =>  { if(d.cap_bucket == 'red'){return 1} return 0} ),
         'per':1,'per_green':1,'per_gray':1,'per_red':1});
        return{'val':0}},d=> Math.round((d.Achievement_TTL-axis.achievemed_min)/factor ) )
        



        X_Domain = []
        i = 1
        while(i <= ( parseInt(metric) +1)){
            X_Domain.push(i*factor)
            i = i+1
        }

       

     var x = d3.scaleBand().range([0, chart_width]).domain(X_Domain).padding(0.1);
     TT_L =  d3.sum(d3.map(plot_data2 , d=> d.cnt))

  TT_GREEN =  d3.sum(d3.map(plot_data2 , d=> d.cnt_green))
     TT_GRAY =  d3.sum(d3.map(plot_data2 , d=> d.cnt_gray))
     TT_RED =  d3.sum(d3.map(plot_data2 , d=> d.cnt_red))


     
i = 0
     while(i <plot_data2.length){
        plot_data2[i].per = plot_data2[i].cnt/TT_L;
        plot_data2[i].per_green = plot_data2[i].cnt_green/TT_GREEN;
        plot_data2[i].per_gray = plot_data2[i].cnt_gray/TT_GRAY;
        plot_data2[i].per_red = plot_data2[i].cnt_red/TT_RED;
         i = i+1
     }
     minval = d3.min(d3.map(plot_data2, d=> d.per ))
     maxval = d3.max(d3.map(plot_data2, d=> d.per ))

     select_bar= 0
     select_next = false
     plot_data2.map(function(d) { if(select_next==true){select_bar = d.max_Achieved;select_next=false} if(d.per==maxval){ select_next = true;}return 0 } )
 


    

    var y = d3.scaleLinear().domain([maxval, 0]).range([0, height]) 
    var y2 = d3.scaleLinear().domain([1, 0]).range([0, height]) 
          
var yaxis_svg = d3.select(chart_id).append("div").attr("class","horizontal_scroll_side_div").append("svg").attr("width","80px").attr("height", height + margin.top + margin.bottom).append("g").attr("transform","translate(" + 75 + "," + margin.top + ")");
var svg = d3.select(chart_id).append("div").attr("class","horizontal_scroll_3").append("svg").attr("width", chart_width ).attr("height", height + margin.top + margin.bottom).append("g").attr("transform","translate(" + 0 + "," + margin.top + ")");


yaxis_svg2 =  d3.select(chart_id).append("div").attr("class","horizontal_scroll_side_div").append("svg").attr("width","80px").attr("height", height + margin.top + margin.bottom).append("g").attr("transform","translate(0 ," + margin.top + " )");




/*svg.selectAll(".Line_cum").data(plot_data2).enter().append("rect").attr("class", "Line_cum").attr("x", function(d) { return x(d.max_Achieved); })
  .attr("width", x.bandwidth()).attr("id",d=>{if(d.max_Achieved==select_bar){return 'default_clk'}}).attr("y", function(d) { return y(d.per); })
  .attr("height", function(d) { return height - y(d.per); }).attr("fill","#bbb");
  */

  cum = 0


  // append the rectangles for the bar chart
  svg.append("g").selectAll(".Hist_bar").data(plot_data2).enter().append("rect").attr("class", "Hist_bar").attr("x", function(d) { return x(d.max_Achieved); })
  .attr("width", x.bandwidth()).attr("id",d=>{if(d.max_Achieved==select_bar){return 'default_clk'}}).attr("y", function(d) { return y(d.per); })
  .attr("height", function(d) { return height - y(d.per); }).attr("fill","#bbb")
  .on("click",function(event,d){
macha = d.max_Achieved
   
      
      d3.selectAll(".Hist_bar").attr('style', d=>{ if(d.max_Achieved <= macha){return 'fill: #8a5f3a;'} return 'fill: #bbb'} )
      
      $("#achievement_filter_value").html( formatValue(d.max_Achieved)  )
      
   
      axis_details =  {'macha':macha,'value_numerator':'C_TTL', 'value_column':'per','sub_plot_dimension_1':'emar_achievement_percent','sub_plot_dimension_2':'non_emar_achievement_percent','x_axis_column': 'agent_non_emar_comission_percentage','y_axis_column': 'TARGET','sub_plot_x_domain' : emar_achievement_percent_range,'sub_plot_y_domain' : non_emar_achievement_percent_range}
        Heat_Map_Sub_Plots("#HeatMapSubPlot",{'subx':new_Target_Range.length,'suby':agent_non_emar_comission_percentage_range.length}, ALL_Results_new.flat() ,axis_details)

         
        final_result =[]
        k = d3.rollup(ALL_Results_new.flat(), v => { 

            if(v[0].Achievement_TTL <= macha){

                if( d3.sum(v,  d =>  {if(d.cap_bucket!="green"){return 1} return 0 } ) == 0){
                    final_result.push({
                    'Target': v[0].TARGET,
                    'comission': v[0].agent_non_emar_comission_percentage
                })
                }
            }    return { 
            'numerator':d3.sum(v,  d =>  {if(d.cap_bucket!="green"){ if(d.Achievement_TTL <= macha ){return 1}} return 0 } )
}}  ,
  d=>d['Achievement_TTL']<=macha,  d => d['agent_non_emar_comission_percentage'],d => d['TARGET']  )
    
   TargetSet =  d3.min(final_result.map(d=>d.Target)) 
   Agent_Comission =  d3.max(final_result.map(d=> {if(d.Target ==TargetSet ){return (d.comission)}return(-100)} )) 
    

  Other_Options_temp = []
   k = d3.rollup(final_result, v => { 
    Other_Options_temp.push({'TARGET':v[0].Target, 'max_staff_comission': d3.max(v,d=>d.comission)  })
    return{

    }
   }, d=>  d['Target']  )

   Other_Options = []
   k = d3.rollup(Other_Options_temp, v => { 
    Other_Options.push({'max_staff_comission':v[0].max_staff_comission, 'Target': d3.min(v,d=>d.TARGET)  })
    return{

    }
   }, d=>  d['max_staff_comission']  )

   console.log(Other_Options)

if(set_compuattion){
   $("#target_computed").html(  formatValue(TargetSet)  )
   $('#staff_comission_coomputed').html(Agent_Comission*100+"%")
   set_compuattion = false
}
   
  })



  plot_data2 = plot_data2.slice().sort((a, b) => d3.ascending( parseInt(a.max_Achieved), parseInt(b.max_Achieved)) || d3.ascending(parseInt(a.max_Achieved), parseInt(b.max_Achieved)))
 

  svg.append("path").datum(plot_data2).attr("fill", "none").attr("stroke", "red").attr("stroke-width", 2)
 .attr("d", d3.line().x(d =>  { return(x(d.max_Achieved))}  ).y(d => {cum = cum + d.per; return y2(cum)} ))


  ;


  svg.append("g").attr("transform", "translate(0," + height + ")").call(d3.axisBottom(x).tickFormat(d => formatValue(d) ));

  // add the y Axis
  yaxis_svg.append("g").call(d3.axisLeft(y).ticks(5).tickSizeOuter(0).tickFormat(d3.format('.00%'))   );

    yaxis_label = yaxis_svg.append("g").append("text").text("% simulations").attr("font-family","Open Sans").attr("font-weight","150").attr("y",-35).attr("transform", "rotate(-90)").attr("text-align","middle")
    yaxis_label.attr('x', function() {return (nodeHeight(this)-height )/2-50  });  
 
    yaxis_svg2.append("g").attr("class","red_axis").call(d3.axisRight(y2).ticks(5).tickSizeOuter(0).tickFormat(d3.format('.00%'))   );
    yaxis_label2 = yaxis_svg2.append("g").append("text").attr("font-family","Open Sans").attr("font-weight","100").attr("font-size","12px").text("Cumulative % simulations").attr("stroke","red").attr("y",54).attr("transform", "rotate(-90)").attr("text-align","middle")
    yaxis_label2.attr('x', function() {return (nodeHeight(this)-height )/2-90  });  

 
 


  jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = new MouseEvent("click");
    e.dispatchEvent(evt);
  });
};
$("#default_clk").d3Click();

         
}


function formatPercentage(number){
return format_per(number)+ "%"
}
var format_per = d3.format(".2f")




function drawviolin(chart_id,data,axis){

    d3.select(chart_id).selectAll("*").remove();

   

   var data_new =  d3.rollup(data, v => {return{'TARGET':v[0].TARGET,
   'cap':v[0].cap,'cnt':d3.sum(v,  d =>  { ;return 1}) }},d=> d.TARGET, d => d.cap)

    var chart_height = 300; var chart_width = 100 * axis.TARGETS_RANGE.length



var margin = {top: 10, right: 30, bottom: 30, left: 40}, width = 1200 - margin.left - margin.right, height = chart_height - margin.top - margin.bottom;



var yaxis_svg = d3.select(chart_id).append("div").attr("class","horizontal_scroll_side_div").append("svg").attr("width","80px").attr("height", height + margin.top + margin.bottom).append("g").attr("transform","translate(" + 75 + "," + margin.top + ")");
var svg = d3.select(chart_id).append("div").attr("class","horizontal_scroll").append("svg").attr("width", chart_width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform","translate(" + 0 + "," + margin.top + ")");


y = d3.scaleLinear().domain([axis.cap_min-.05, axis.cap_max]).range([height, 0])
yaxis_svg.append("g").call( d3.axisLeft(y).ticks(5).tickSizeOuter(0).tickFormat(d3.format('.0%')) )  
yaxis_label = yaxis_svg.append("g").append("text").text("CapX").attr("y",-40).attr("transform", "rotate(-90)").attr("text-align","middle")
yaxis_label.attr('x', function() {return (nodeHeight(this)-height )/2});


var x = d3.scaleBand().domain(axis.TARGETS_RANGE).range([0,chart_width ]).paddingInner(0.05)  ;
svg.append("g").attr("transform", "translate(0," + height + ")").call(d3.axisBottom(x).tickFormat(d => formatValue(d) )) 
    

svg.append("g").append("line").attr("x1", 0 ).attr("x2", chart_width ).attr("y1",y(.18)).attr("y2",y(.18)).attr("stroke","red") 

    
    for ([key,value] of data_new.entries()){
        plot_data =[]
        for ([key2,value2] of value.entries()){plot_data.push(value2) }

        max_cnt = d3.max(d3.map(plot_data,d=> d.cnt))
        working_space = svg.append("g").attr("transform", "translate("+x(key)+",0)")
        factor = x.bandwidth()/max_cnt
        working_space.selectAll("rect").data(plot_data).enter().append("rect").attr("x", d => (x.bandwidth()-d.cnt*factor)/2 ).attr("y",d=>y(d.cap)).attr("width",d=>d.cnt*factor).attr("height", y(0)-y(0.01)  ).attr("fill","#8a9dbb")
       

    }


}





  



function formatNumber(n){return String(n).replace(/(.)(?=(\d{3})+$)/g,'$1,')    }


     $("input").change(function(){
        $('#'+$(this).attr('id')+'_label').html(formatNumber($(this).val()))
      
        $("#gm_target_factor_label").html( 100-parseInt($("#gm_target_factor_inv").val() ) );
      });


     $("#simulate_start").click(function() {
        set_compuattion = true
        ALL_Results = []
        var operation_cost_Range = []
         agent_emar_comission_percentage_range = []
          agent_non_emar_comission_percentage_range = []
        var emar_target_percentage_range= []
         emar_achievement_percent_range = []
        non_emar_achievement_percent_range= []
       var GM_TARGET_Range = []

        $("#simulate_update").html("Simulate Start");
        $("#Target_result").html( "")
        $("#GM_Target_result").html( "")
        $("#Min_Net_Profit").html("")
        $("#Max_Net_Profit").html("")
       var operation_cost =  $('#operational_cost').val();
     
        var simulate_iter = 0
        while(simulate_iter < 6){
            operation_cost_Range.push(operation_cost*(1-simulate_iter/20))
            simulate_iter = simulate_iter+1
        }

      
        
        var agent_comission = $('#agent_comission').val();

       
        var gm_target_factor = 100 - parseInt($('#gm_target_factor_inv').val());
        var simulate_iter = parseInt(gm_target_factor)
        while((simulate_iter+5) <= 100){
            GM_TARGET_Range.push((simulate_iter+5)/100)
            simulate_iter = simulate_iter +5
        }
       

        var emar_target_percentage = $('#emar_target_percentage').val();
        var emar_achievement_percentage = $('#emar_achievement_percentage').val();
        var non_emar_achievement_percentage = $('#non_emar_achievement_percentage').val();
        
      
     

        var simulate_iter = 0
        while(simulate_iter+55 <= agent_comission){
            agent_emar_comission_percentage_range.push((55+simulate_iter)/100)
            agent_non_emar_comission_percentage_range.push((55+simulate_iter)/100)
            simulate_iter = simulate_iter+1
        }

        var simulate_iter = 0
        while(simulate_iter <= emar_target_percentage){
            emar_target_percentage_range.push((simulate_iter+5)/100)
            simulate_iter = simulate_iter +5
        }


        var simulate_iter = 50
        while(simulate_iter <= (emar_achievement_percentage-50)){
            emar_achievement_percent_range.push((simulate_iter+50)/100)
            simulate_iter = simulate_iter +100
        }

        var simulate_iter = 50
        while(simulate_iter <= (non_emar_achievement_percentage-50)){
            non_emar_achievement_percent_range.push((simulate_iter+50)/100)
            simulate_iter = simulate_iter +100
        }

         TARGETS_RANGE =[]
        var TARGET = operation_cost;
        var found_plan = 0
        var operation_cost_org = operation_cost;
        cap_min = 10;
        cap_max = -1;
        achievemed_min = 10;
        achievemed_max = -1;
        while( found_plan == 0)
        {
            $("#simulate_update").html( "Trying for Target  " +formatNumber(TARGET) )
            TARGETS_RANGE.push(TARGET)
           
            Simulation_Result = Simulate(TARGET,GM_TARGET_Range,operation_cost_Range,agent_emar_comission_percentage_range,agent_non_emar_comission_percentage_range,emar_target_percentage_range,emar_achievement_percent_range,non_emar_achievement_percent_range)
       
            ALL_Results.push(Simulation_Result)
            var cmin = d3.min(d3.map(Simulation_Result, e => e['cap']))
            var cmax = d3.max(d3.map(Simulation_Result, e => e['cap']))
            var a_min = d3.min(d3.map(Simulation_Result, e => e['Achievement_TTL']))
            var a_max = d3.max(d3.map(Simulation_Result, e => e['Achievement_TTL']))
            if(a_min < achievemed_min){
                achievemed_min = a_min
            }
            if(a_max > achievemed_max){
                achievemed_max = a_max
            }
            if(cmax > cap_max){
                 cap_max = cmax
            }
            if(cmin < cap_min){
                cap_min = cmin
            }
            if(cmin >= 0){
                if(cmax <= .18){
                    found_plan = 1 
                    var min_net_profit = d3.min(d3.map(Simulation_Result, e => e['Net_Profit'])) 
                    var max_net_profit =  d3.max(d3.map(Simulation_Result, e => e['Net_Profit'])) 
                    break;
                }
            }
            
            TARGET = parseInt(TARGET) + 100000
            if(TARGET > 100 * operation_cost_org){
                console.log("No Luck")
                break;
            }
            
            
            
        }
     
       
        if(found_plan==1){
            
            $("#no_targets_analyzed").html( formatNumber(ALL_Results.length * ALL_Results[0].length ))

            new_Target_Range = []
            ALL_Results_new =[]
            it = 1
            stop_in_next_3 = 0
            o = 0
           while(it < ALL_Results.length){
                it = it + 5;
                new_Target_Range.push(ALL_Results[ALL_Results.length-it][0].TARGET)
                ALL_Results_new.push(ALL_Results[ALL_Results.length-it])
               o = o+1
                if(stop_in_next_3 > 0){
                    stop_in_next_3 = stop_in_next_3 -1
                }else{
                if(d3.min(ALL_Results[ALL_Results.length-it], d => d.Net_Profit) < 0 ){
                    stop_in_next_3 = 3
                }}
                if(stop_in_next_3 ==1){
                    break;
                }
                
                
                
            }
           
     /*  if(ALL_Results.length >= 40){
            new_Target_Range = [ALL_Results[ALL_Results.length-1][0].TARGET,ALL_Results[ALL_Results.length-5][0].TARGET, ALL_Results[ALL_Results.length-10][0].TARGET,ALL_Results[ALL_Results.length-15][0].TARGET,ALL_Results[ALL_Results.length-20][0].TARGET,ALL_Results[ALL_Results.length-25][0].TARGET]
             ALL_Results_new = [ALL_Results[ALL_Results.length-1],ALL_Results[ALL_Results.length-5],ALL_Results[ALL_Results.length-10],ALL_Results[ALL_Results.length-15],ALL_Results[ALL_Results.length-20],ALL_Results[ALL_Results.length-25] ]
               
    }*/
            $("#Target_result").html(formatNumber(TARGET))
            $("#GM_Target_result").html(formatNumber(TARGET*gm_target_factor/100))
            $("#Min_Net_Profit").html(formatNumber(Math.round(min_net_profit)))
            $("#Max_Net_Profit").html(formatNumber(Math.round(max_net_profit)))
            $("#simulate_update").html(" ");
            ALL_Results = ALL_Results.flat()
            
            
          
            axis_details =  {'x_axis_level_2_domain': new_Target_Range, 'x_axis_level_1_domain': agent_emar_comission_percentage_range, 'x_axis_level_2':'TARGET','x_axis_level_1':'agent_emar_comission_percentage', 'y_axis':'cap'}
            nested_x_axis_box_plot("#StaffPercentage_chart", ALL_Results_new.flat() ,axis_details)

           /* axis_details = {'x_axis':'TARGET', 'y_axis':'agent_emar_comission_percentage','conditioned_column':'cap_bucket','conditioned_value':'green'}
            AreaChart("#Target_Staff_Percentage_Trend", ALL_Results,axis_details)*/

            axis_details = {'TARGETS_RANGE':new_Target_Range, 'cap_min':cap_min,'cap_max':cap_max}
            drawviolin("#Target_Capx_Achievement_Violin",ALL_Results_new.flat(),axis_details)

            axis_details = {'x_axis':'Achievement_TTL', 'color_by':'cap_bucket', 'achievemed_min':achievemed_min, 'achievemed_max':achievemed_max}
           draw_mixed_plot("#Actual_Achieved_byCapx",ALL_Results,axis_details,20)
            
           
        }
       else{
        $("#simulate_update").html("Something un expected happened ");
       }
       
        });
</script>
<script>



function compute_capx(f_TARGET,f_GM_TARGET_Per,plan,f_operation_cost, f_emar_target_percentage, f_emar_achievement_percent, f_non_emar_achievement_percent)
{
    

    var f_GM_TARGET = f_GM_TARGET_Per * f_TARGET
    var f_emar_target = f_TARGET * f_emar_target_percentage



    var f_non_emar_target_percentage = 1- f_emar_target_percentage
    var f_non_emar_target = f_TARGET * f_non_emar_target_percentage 

    var f_emar_achievement = f_emar_target * f_emar_achievement_percent
 
    var f_non_emar_achievement = f_non_emar_target * f_non_emar_achievement_percent 
    var f_emar_achievement_per_ttl = f_emar_achievement/(f_non_emar_achievement+f_emar_achievement)
   
    var f_Achivement = (f_emar_achievement+f_non_emar_achievement)
    var f_Agent_emar_payout = f_emar_achievement * plan['agent_emar_comission_percentage']
    var f_Agent_non_emar_payout = f_non_emar_achievement * plan['agent_non_emar_comission_percentage']

    var f_Agent_payout = f_Agent_emar_payout+f_Agent_non_emar_payout
    var f_Net_emar = f_emar_achievement - f_Agent_emar_payout
    var f_Net_non_emar = f_non_emar_achievement - f_Agent_non_emar_payout

    var slab1 = 0;
    var slab2 = 0;
    var slab3=0;
    var slab4=0
 
    if(f_emar_achievement_percent >= 1){
        slab1 =  Math.min(1,f_emar_achievement_percent)*plan['c1_p1']*(1-plan['agent_emar_comission_percentage'])
        slab2 =  Math.max(Math.min(.5, f_emar_achievement_percent-1),0)*plan['c2_p1']*(1-plan['agent_emar_comission_percentage'])
        slab3 =  Math.max(Math.min(.5, f_emar_achievement_percent-1),0)*plan['c3_p1']*(1-plan['agent_emar_comission_percentage'])
        slab4 =  Math.max(f_emar_achievement_percent-2,0)*plan['c4_p1']*(1-plan['agent_emar_comission_percentage'])
    }   
    else if(f_emar_achievement_percent >= .85){
        slab1 =  Math.min(1,f_emar_achievement_percent)*plan['c1_p2']*(1-plan['agent_emar_comission_percentage'])
    }
        
    f_Manager_emar_payout =  (slab1+slab2+slab3+slab4)*f_emar_target
    f_Manager_non_emar = 0;slab1 = 0;slab2 = 0;slab3=0;slab4=0

    if(f_non_emar_achievement_percent >= .85){
        slab1 =  Math.min(1,f_non_emar_achievement_percent)*plan['c1_p2']*(1-plan['agent_non_emar_comission_percentage'])
        slab2 =  Math.max(Math.min(.5, f_non_emar_achievement_percent-1),0)*plan['c2_p2']*(1-plan['agent_non_emar_comission_percentage'])
        slab3 =  Math.max(Math.min(.5, f_non_emar_achievement_percent-1),0)*plan['c3_p2']*(1-plan['agent_non_emar_comission_percentage'])
        slab4 =  Math.max(f_non_emar_achievement_percent-2,0)*plan['c4_p2']*(1-plan['agent_non_emar_comission_percentage'])
    }
        
    f_Manager_non_emar_payout =  (slab1+slab2+slab3+slab4)*f_non_emar_target
    
    f_Manager_payout = f_Manager_non_emar_payout+f_Manager_emar_payout
    f_Net = f_Achivement -f_Manager_payout -f_Agent_payout
    
    f_GM_achievement_percentage = (f_Achivement)/f_GM_TARGET
    
    if(f_GM_achievement_percentage >= 2){
        f_General_Manager_Payout = f_Net * plan['c3_p3']
    }
    else if( f_GM_achievement_percentage >= 1.25){
        f_General_Manager_Payout = f_Net * plan['c2_p3']
    }
    else if( f_GM_achievement_percentage >= 1){
        f_General_Manager_Payout = f_Net * plan['c1_p3']
    }
    else{
        f_General_Manager_Payout = 0
    }

    f_operation_cost_percent = f_operation_cost/f_Achivement
   
    f_TT_Comission_Payout = f_General_Manager_Payout + f_Manager_payout + f_Agent_payout
    
    f_Net_Profit = f_Achivement - f_operation_cost - f_TT_Comission_Payout
    
  
    
    cap_emar = -1
    cap_non_emar = -1
    if(f_Net_Profit<=0){
        cap = -.05
        cap_bucket = 'gray'
        
    }
        
    else{
        cap = (f_General_Manager_Payout + f_Manager_payout)/f_Net_Profit
        if(cap < 0){
            cap = -.05
            cap_bucket = 'gray'}
        else if(cap < .18){  
            cap_bucket ='green'
        } 
        else if(cap > .4){  
            cap = .4
        } 
        else{ 
            cap_bucket ='red'}
    }
    return({'TARGET':f_TARGET,'Achievement_TTL':f_Achivement,'GM_Target_per':f_GM_TARGET_Per,'GM_TARGET':f_GM_TARGET,'emar_target_percentage':f_emar_target_percentage,  'emar_achievement_percent':f_emar_achievement_percent, 'agent_emar_comission_percentage':plan['agent_emar_comission_percentage'], 'Agent_emar_payout':f_Agent_emar_payout,'non_emar_achievement_percent':f_non_emar_achievement_percent, 'agent_non_emar_comission_percentage':plan['agent_non_emar_comission_percentage'],'Agent_non_emar_payout':f_Agent_non_emar_payout,'cap_bucket':cap_bucket,'cap':cap.toFixed(2) , 'operation_cost':f_operation_cost  ,'Manager_payout':f_Manager_payout,'General_Manager_Payout':f_General_Manager_Payout,'Net_Profit':f_Net_Profit })
}
   
function Simulate(TARGET,GM_TARGET_Range,operation_cost_Range,agent_emar_comission_percentage_range,agent_non_emar_comission_percentage_range,emar_target_percentage_range,emar_achievement_percent_range,non_emar_achievement_percent_range){
    var Simulation_Result = [] 
    i = 0
    w = 0
    print_percentage=[10.0,20.0,30.0,40.0,50.0,60.0,70.0,80.0,90.0]     
    TTL_Count = GM_TARGET_Range.length* operation_cost_Range.length* agent_emar_comission_percentage_range.length * agent_non_emar_comission_percentage_range.length*emar_target_percentage_range.length*emar_achievement_percent_range.length*non_emar_achievement_percent_range.length
    plan  = {'c1_p1':.03,'c2_p1':.06,'c3_p1':.08,'c4_p1':.10,'c1_p2':.02,'c2_p2':.03,'c3_p2':.04,'c4_p2':.05,'c1_p3':.02 ,'c2_p3':.03, 'c3_p3':.06}



    for(GM_TARGET in GM_TARGET_Range){
        GM_TARGET = GM_TARGET_Range[GM_TARGET]
    
        for(operation_cost in operation_cost_Range){
            operation_cost = operation_cost_Range[operation_cost]
            for(agent_comission_percentage in agent_emar_comission_percentage_range){
                agent_comission_percentage = agent_emar_comission_percentage_range[agent_comission_percentage]
                
                for(emar_target_percentage in emar_target_percentage_range){
                    emar_target_percentage = emar_target_percentage_range[emar_target_percentage]
           
                    for(emar_achievement_percent in emar_achievement_percent_range){
                        emar_achievement_percent = emar_achievement_percent_range[emar_achievement_percent]
           
                        for(non_emar_achievement_percent in emar_achievement_percent_range){
                            non_emar_achievement_percent = non_emar_achievement_percent_range[non_emar_achievement_percent]
           
                            agent_emar_comission_percentage = agent_comission_percentage
                           
            
                            agent_non_emar_comission_percentage = agent_emar_comission_percentage
                        
                            plan['agent_emar_comission_percentage'] = agent_emar_comission_percentage
                            plan['agent_non_emar_comission_percentage'] = agent_emar_comission_percentage

                            non_emar_target_percentage = (1 - emar_target_percentage)
                            
                            res = compute_capx(TARGET,GM_TARGET,plan,operation_cost, emar_target_percentage, emar_achievement_percent, non_emar_achievement_percent)
                   
                            Simulation_Result.push(res)
                            
                        }
                        
                    }
                    
                        
                }
                   

           }
                
        }
    }

return Simulation_Result
}

  


</script>



<script>
formatValue2_digit = d3.format(".2s");
formatValue3_digit = d3.format(".3s");
function formatValue(d){
    if(d < 10000000){return formatValue2_digit(d)}
    else{return formatValue3_digit(d)}
}
var nodeWidth = (d) => d.getBBox().width;

var nodeHeight= (d) => d.getBBox().height;





function nested_x_axis_box_plot(chart_id,data,axis){

   

    d3.select(chart_id).selectAll("*").remove();


    var sub_plot_width = 500
    var margin = {top: 80, right: 25, bottom: 30, left: 40}

    var width = (sub_plot_width*axis.x_axis_level_2_domain.length) - margin.left - margin.right
    var height = 380 - margin.top - margin.bottom;


    var svg_org =  d3.select(chart_id).append("svg").attr("width",1700).attr("height", 60)

    var svg_y = d3.select(chart_id).append("div").attr("class",'horizontal_scroll_side_div').append("svg").attr("width",80).attr("height", height + margin.bottom).attr("transform", `translate(0, 0)`);
   
    var svg =  d3.select(chart_id).append("div").attr("class","horizontal_scroll_2").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.bottom).attr("transform", `translate(0, 0)`);
   // var bottom_axis_svg = d3.select(chart_id).append("div").append("svg").attr("width", 1700).attr("height",30).attr("transform", `translate(${margin.left}, 0)`); 
   // bottom_axis_text = bottom_axis_svg.append("text").text("Agent Comission").attr("x",0).attr("y",15).attr("font-size","20px").attr("fill","blue" )
   // bottom_axis_svg.append("line").style("stroke", "blue").attr("stroke-opacity",.2).style("stroke-width", 2).attr("x2", 1200  ).attr("x1",100).attr("y2",10).attr("y1",10)
   // bottom_axis_text.attr("transform", function() {return ( "translate(" + (1400 - nodeWidth(this))/2 + ",0)"  )});
   
    const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])
    var color_legend = svg_org.append("g")

    
    color_legend.append("text").attr("x",0).attr("y",10).text("color by #simulations")
    color_legend.append("text").attr("x",10).attr("y",25).text("failed capx criteria")
    color_legend.append("circle").attr("cx",150).attr("cy",15).attr("r",10).attr("fill","#5d8700")
    color_legend.append("text").attr("x",150).attr("y",19).attr("text-anchor","middle").text("0")
    i = 0
    string_val = " simulation"
while(i < 10){
    var clr = "white";
    if(i < 3){
        clr = "black"
    }
    color_legend.append("circle").attr("cx",(i+1)*20+150).attr("cy",15).attr("r",10).attr("fill",myColor(i))
    color_legend.append("text").attr("x",(i+1)*20+150).attr("y",19).attr("text-anchor","middle").text(i+1).attr("fill", clr )
   i = i+1
    }

    color_legend.attr("transform", function() {return ( "translate(" + (1400 - nodeWidth(this))/2 + ",0)"  )});

    var ttl_min_net_profit = 10000000000
    var ttl_max_net_profit = -1

    var data = d3.rollup(data, v => {
        
      

        return { 'x_axis_level_1': v[0][axis.x_axis_level_1],'x_axis_level_2':v[0][axis.x_axis_level_2] , 
    'color_value':d3.sum(v,  d =>  {if(d.cap_bucket!="green"){ ;return 1} else{;return 0} } ),  'color_value_per':d3.sum(v,  d =>  { return 1}   ) ,
    'min_value': d3.min(v, d => d[axis.y_axis]),'max_value': d3.max(v, d => d[axis.y_axis]),
'q1':d3.quantile(v.map(function(d) { return d[axis.y_axis];}).sort(d3.ascending),.5),
'q3':d3.quantile(v.map(function(d) { return d[axis.y_axis];}).sort(d3.ascending),.95),
'median':d3.quantile(v.map(function(d) { return d[axis.y_axis];}).sort(d3.ascending),.5),
'cv' : d3.max(v,d=>{ if(ttl_min_net_profit > d[axis.y_axis]){ttl_min_net_profit =d[axis.y_axis] }  if(ttl_max_net_profit < d[axis.y_axis]){ttl_max_net_profit =d[axis.y_axis] }  return 0})} } ,d => d[axis.x_axis_level_2],d => d[axis.x_axis_level_1]  )

    var sub_plot_x_scale_level_2 = d3.scaleBand().domain(axis.x_axis_level_2_domain).range([margin.left,(sub_plot_width*axis.x_axis_level_2_domain.length ) ]).paddingInner(0.05)  ;
  
    
    const yscale = d3.scaleLinear().range([ height , 10 ]).domain([ttl_min_net_profit,ttl_max_net_profit]);
    yaxis_scale = svg_y.append("g").attr("class",'yaxisscale')
    if(axis.y_axis=='cap')
    {
    yaxis_scale.append("g").style("font-size", 15).attr("transform", `translate( `+ ((margin.left)+30)+`,0)`).call(d3.axisLeft(yscale).tickSize(0).ticks(10).tickFormat(d3.format('.0%')) ).select(".domain").remove()
    yaxis_label = yaxis_scale.append("g").append("text").text("CapX").attr("y",20).attr("transform", "rotate(-90)").attr("text-align","middle")
    }else
    {
    yaxis_scale.append("g").style("font-size", 15).attr("transform", `translate( `+ ((margin.left)+30)+`,0)`).call(d3.axisLeft(yscale).tickSize(0).ticks(10).tickFormat(d => formatValue(d) )   ).select(".domain").remove()
    yaxis_label = yaxis_scale.append("g").append("text").text("Net Profit").attr("y",20).attr("transform", "rotate(-90)").attr("text-align","middle")
    }

    yaxis_label.attr('x', function() {return (nodeHeight(this)-height )/2});


    x_scale_level_2_text = svg.append("g")

    show_xaxis_level_2 = true;
    axis.x_axis_level_2_domain.forEach( 
        x_scale_level_2 => {
                 var text =x_scale_level_2_text.append("text").text( "Target :" + formatValue(x_scale_level_2)  ).attr("x",sub_plot_x_scale_level_2(x_scale_level_2)+ sub_plot_x_scale_level_2.bandwidth()/2).attr("fill","green").attr("font-size","18px").attr('y',15).attr("text-anchor","middle");
                 text.attr("transform", function() {return ( "translate(" + sub_plot_x_scale_level_2.bandwidth() - nodeWidth(this)) + ",0)" } );

                        var sub_plot_data = []
                        consider_data = data.get(x_scale_level_2)
                        for ([key,value] of consider_data.entries()){sub_plot_data.push(value)}
                    var working_svg = svg.append("g").attr("transform", "translate("+sub_plot_x_scale_level_2(x_scale_level_2)+",0)")
                    //var axis_working = axissvg.append("g").attr("transform", "translate("+sub_plot_x_scale(sub_x_domain)+", 0)")

                BoxPlot(sub_plot_data,working_svg,(sub_plot_width-50) ,height, axis.x_axis_level_1_domain,yscale)
                show_yaxis = false
                    }
                );
            

}


function BoxPlot(data,box_pot_svg,width,height,x_axis_level_1_domain, yscale){

    const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])

    const x = d3.scaleBand().range([  0,width ]).domain(x_axis_level_1_domain).padding(0.05);
    box_pot_svg.append("g").attr('class','xaxis').style("font-size", 15).attr("transform", `translate(0, `+(height)+`)`)
    .call(d3.axisBottom(x).tickSize(0).tickFormat(d3.format('.0%'))  ) .selectAll("text").style("text-anchor", "middle")  
  
    var working_space = box_pot_svg.append("g").attr("class","working_space");

    vertical_lines =  working_space.append("g")
    vertical_lines.append("g").selectAll().data(data).enter().append("line").style("stroke", "#aaa").style("stroke-width", 2).attr("x2",d=>(x(d.x_axis_level_1)+x.bandwidth()/2-5)  ).attr("x1",d=>(x(d.x_axis_level_1)+x.bandwidth()/2-5)).attr("y2",d=>yscale(d.max_value)).attr("y1",d=>yscale(d.min_value))

    boxes =  working_space.append("g")
    boxes.append("g").selectAll("rect").data(data).enter()
    .append("rect").attr("y", d=> yscale(d.q3)).attr("x",d=>x(d.x_axis_level_1)).attr("height",d=> { return(yscale(d.q1) - yscale(d.q3) ) } )
    .attr("width",x.bandwidth()-10).attr("fill",d=>{if(d.color_value==0){return  "#5d8700"} else{return myColor( Math.min(d.color_value,10))}  })
    .on("mouseover", function(event,d) {		
      
            div.style("opacity", 1);		
            div	.html(  "for all the simulations that are run for the Target "+  formatValue(d.x_axis_level_2)+", and Agent comission "+ Math.round(d.x_axis_level_1*100) +"% <br> the Net profit ranged mostly between " + formatValue(d.q1) +" and "+ formatValue(d.q3) +` with few extremities marked by the line. <br> 
        Of these simulations `+ d.color_value +' simulations failed to adhere 18% cap <span style="font-size:8px"> (which is the color of the bar)</span>')	
                .style("left", (event.pageX-220) + "px")		
                .style("top", (event.pageY - 28) + "px");	
            })					
        .on("mouseout", function(d) {		
            div.style("opacity", 0);	
        }).on("click",function(event,d){

            populate_table(d.x_axis_level_1,d.x_axis_level_2)
            
        }).on("dblclick",function(event,d){

        if(start_script == 1){
            sceanriotable.clear();
            sceanriotable.destroy();
            
            start_script = 0
        }

          


})
        ;

    boxes.append("g").selectAll().data(data).enter().append("text").attr("class","text_labels").attr("text-anchor","middle").attr("x",d=>x(d.x_axis_level_1)+x.bandwidth()/2 - 2).attr("y",d=> { return( yscale(d.q3) + (yscale(d.q1) - yscale(d.q3))/2 ) } ).text( d=> d.color_value).attr("fill",d=> {if(d.color_value <= 3){return "black"} else{return "white"}}) 

    var div = d3.select("body").append("div").attr("id","box_plot_tooltip").attr("class", "tooltip").style("opacity", 0);


  
   



}
function populate_table(agent_comission, target_value){


    if(start_script == 1){
        sceanriotable.clear();
            sceanriotable.destroy();
            start_script = 0
        }
 

  
   var dataSet = []
   i = 0
   html_string = ""
     ALL_Results.map(d => {
     if(d.TARGET==target_value){
         
         if(d.agent_emar_comission_percentage==agent_comission){
             if(d.cap_bucket!='green'){
                html_string = html_string+`
          <tr>
            <td">`+i+`</t>
            <td>`+ formatValue(d.TARGET) +`</td>
            <td>`+Math.round(d.emar_target_percentage*100)+`%</td>
            <td >`+Math.round(d.GM_Target_per*100)+`%</td>

            <td >`+Math.round(d.agent_emar_comission_percentage*100)+`%</td>

            <td >`+ Math.round(d.emar_achievement_percent*100)  +`% </td>
            <td >`+ Math.round(d.non_emar_achievement_percent*100) +`% </td>
      

            <td >`+ formatValue(d.operation_cost) +`</td>
            <td>`+ Math.round(d.cap*100,2) +`%</td>
            <td >`+ formatValue(d.Net_Profit) +`</td>
            <td>`+ formatValue(d.Manager_payout) +`</td>
      
           
          </tr>`
          //datatable.rows.add();
          dataSet.push([i,formatValue(d.TARGET),Math.round(d.emar_target_percentage*100),Math.round(d.GM_Target_per*100),Math.round(d.agent_emar_comission_percentage*100),Math.round(d.emar_achievement_percent*100),Math.round(d.non_emar_achievement_percent*100),formatValue(d.operation_cost), Math.round(d.cap*100,2) , formatValue(d.Net_Profit), formatValue(d.Manager_payout)])
                i = i+1
             }
         }
        }
     });
     
     sceanriotable = $('#scenario_table').DataTable( {
            data: dataSet,
            columns: [
                { title: "#" },
                { title: "TARGET" },
                { title: "%EEEE-TARGET" },
                { title: "General Manager Target" },
                { title: "Staff comission%" },
                { title: "EEEE Achievement %" },
                { title: "NON-EEEE Achievement % " },
                { title: "Operational Cost" },
                { title: "Net Profit" },
                { title: "Managaer Payout" }
            ]
        } );
    start_script = 1
    // d3.select("#failed_scenarios").html(html_string);
   


 //'Agent_emar_payout':,'Agent_non_emar_payout':  ,'Manager_payout':,'General_Manager_Payout':,'Net_Profit'



}

function Heat_Map_Sub_Plots(chart_id,dimension,data,axis){

    d3.select(chart_id).selectAll("*").remove();

    var sub_plots_x_column_name = axis.sub_plot_dimension_1; var sub_plots_y_column_name = axis.sub_plot_dimension_2
    var y_axis_column = axis.x_axis_column; var x_axis_column = axis.y_axis_column; var value_column = 'percentage'
    sub_plot_x_domain = axis.sub_plot_x_domain; sub_plot_y_domain = axis.sub_plot_y_domain;
     var sub_plot_width = (dimension.subx*40+50); var sub_plot_heght= (dimension.suby*40+50); 
     var margin = {top: 80, right: 25, bottom: 30, left: 40},
     width = (sub_plot_width*sub_plot_x_domain.length) - margin.left - margin.right,
     height = sub_plot_heght* sub_plot_y_domain.length- margin.top - margin.bottom;
    


    data = d3.rollup(data, v => {return { 'x_axis_column': v[0][x_axis_column],'y_axis_column':v[0][y_axis_column] ,
    'sub_plots_x_column_name': v[0][sub_plots_x_column_name],'sub_plots_y_column_name': v[0][sub_plots_y_column_name], 
    'numerator':d3.sum(v,  d =>  {if(d.cap_bucket!="green"){ if(d.Achievement_TTL <= axis.macha ){return 1}} return 0 } ),
    'numerator_all':d3.sum(v,  d =>  {if(d.cap_bucket!="green"){return 1} return 0 } ),
    'black_out':d3.sum(v,  d =>  {if(d.Achievement_TTL <= axis.macha){return 1} return 0 } )
    ,'denominator': d3.sum(v, d => 1), 'val' : (d3.sum(v,  d =>  {if(d.cap_bucket=="green"){return 1} else{return 0} } ) / d3.sum(v, d => 1))}}  ,
    d => d[sub_plots_x_column_name],d => d[sub_plots_y_column_name],d => d[y_axis_column],d => d[x_axis_column]  )
    
    
    
    var top_svg = d3.select(chart_id).append("div").append("svg").attr("width", 1400 ).attr("height", 80 ).attr("transform", "translate("+0+", 0)").append("g")
   
    //var svg_y = d3.select(chart_id).append("div").attr("class",'horizontal_scroll_side_div').append("svg").attr("width",80).attr("height", sub_plot_heght+ margin.top+margin.bottom).attr("transform", `translate(0, 0)`);
    var svg= d3.select(chart_id).append("div").attr("class",'custom-scroll').style('height','435px').append("div").attr("class",'anti-dir').append("svg").attr("width", width ).attr("height", (height) ).append("g");
    //var x_subplot = svg_wkng.append("g")
    //var svg = svg_wkng.append("g").attr("transform", "translate(0, 50)");

    sub_plot_x_scale = d3.scaleBand().domain(sub_plot_x_domain).range([margin.left,width - margin.right]);
    sub_plot_y_scale = d3.scaleBand().domain(sub_plot_y_domain).range([0,height - margin.bottom]);

   // top_svg.append('line').style("stroke", "#aaa").style("stroke-width", 2).attr("x1", 25).attr("y1", 20).attr("x2", 1400).attr("y2", 20); 
    
    const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])
    var color_legend = top_svg.append("g")

    color_legend.append("circle").attr("cx",150).attr("cy",15).attr("r",10).attr("fill","black")
    color_legend.append("text").attr("x",15).attr("y",16).attr("text-anchor","start").text("non probable case")
    color_legend.append("text").attr("x",0).attr("y",27).attr("font-size","11px").attr("text-anchor","start").text("from Achievement threshold")

    
    color_legend.append("text").attr("x",170).attr("y",10).text("#simulations failed")
    color_legend.append("text").attr("x",170).attr("y",25).text("for capx criteria")
    color_legend.append("circle").attr("cx",315).attr("cy",15).attr("r",10).attr("fill","#5d8700")
    color_legend.append("text").attr("x",315).attr("y",19).attr("text-anchor","middle").text("0")
    i = 0
    string_val = " simulation"
while(i < 10){
    var clr = "white";
    if(i < 3){
        clr = "black"
    }
    color_legend.append("circle").attr("cx",(i+1)*20+315).attr("cy",15).attr("r",10).attr("fill",myColor(i))
    color_legend.append("text").attr("x",(i+1)*20+315).attr("y",19).attr("text-anchor","middle").text(i+1).attr("fill", clr )
   i = i+1
    }

    color_legend.attr("transform", function() {return ( "translate(" + (1300 - nodeWidth(this))/2 + ",10)"  )});




    
    //subplot_x_text =    //subplot_x_text.attr('transform', function() {return `translate(${(1400 - nodeWidth(this)) / 2},${25})`});

    
    show_xaxis = true
    show_yaxis = true

    sub_plot_y_domain.forEach(
    
        sub_y_domain => {
            show_xaxis = true;
            sub_plot_x_domain.forEach(
                
                sub_x_domain => {
                
                        var sub_plot_data = []
                        consider_data = data.get(sub_x_domain).get(sub_y_domain)
                    
                        consider_data.forEach(element => {element.forEach(ele2 => sub_plot_data.push(ele2))});
                    var working_svg = svg.append("g").attr("transform", "translate("+sub_plot_x_scale(sub_x_domain)+", "+sub_plot_y_scale(sub_y_domain)+")")
                    //var axis_working = axissvg.append("g").attr("transform", "translate("+sub_plot_x_scale(sub_x_domain)+", 0)")

             
                HeatMap(sub_plot_data,working_svg,(sub_plot_width-70) ,(sub_plot_heght-70),sub_x_domain,true, true,sub_x_domain,sub_y_domain)
                show_xaxis = false
                    }
                );
                
                } 
            
                
                ) 
            


}

function HeatMap(data,svg,width,height,sub_x_domain, show_yaxis, show_xaxis,x_axis_sub_group,y_axis_sub_group){
chart_margin = 0; if(show_yaxis){chart_margin = 30;}
const myGroups = Array.from(new Set(data.map(d => d.x_axis_column)))
const myVars = Array.from(new Set(data.map(d => d.y_axis_column)))

height = height -30
const x = d3.scaleBand().range([ width,chart_margin ]).domain(myGroups).padding(0.02); 
var borderPath = svg.append("g").append("rect").attr("x", chart_margin).attr("y", 0).attr("height", 30).attr("width", (width-chart_margin ))
.attr("stroke", "white").attr("stroke-width", "3px").attr("fill","#8a5f3a");
var text = svg.append("g").append("text").attr("x", width/2).attr("y", 20).attr("text-anchor","middle").text("EEE Achievement = " + x_axis_sub_group + "   ; Non-EEE Achievement ="+ y_axis_sub_group).attr("font-size","14px");

var working_space= svg.append("g").attr("transform", `translate(0,30)`)
if(show_xaxis){working_space.append("g").style("font-size", 12).attr("transform", `translate(0, `+(height)+`)`).call(d3.axisBottom(x).tickSize(0).tickFormat(d => formatValue(d) )).select(".domain").remove()};
  
const y = d3.scaleBand().range([ height,0 ]).domain(myVars).padding(0.05);
if(show_yaxis){
    working_space.append("g").style("font-size", 12).attr("transform", `translate( `+chart_margin+`,0)`).call(d3.axisLeft(y).tickSize(0).tickFormat( d3.format('.0%') )).select(".domain").remove()
    yaxis_label = working_space.append("text").text("Staff comission %").attr("stroke","#aaa").attr("text-anchor", "middle").attr("x", height/2+20).attr("y",-10).attr("transform", "rotate(-90)")
   // yaxis_label.attr('x', function() {return (-1* nodeHeight(this)/2 ) });
}



const myColor = d3.scaleLinear().range(["#e97452", "#8b0001"]).domain([1,10])

var i = 0

//const tooltip = working_space.append("div").style("opacity", 0).attr("class", "tooltip").style("background-color", "white").style("border", "solid") .style("border-width", "2px") .style("border-radius", "5px").style("padding", "5px")


working_space.append("g").selectAll().data(data, function(d) {return d.x_axis_column+':'+d.y_axis_column;})
.join("rect").attr("x", function(d) { return x(d.x_axis_column) }).attr("y", function(d) { return y(d.y_axis_column) }).attr("width", x.bandwidth() ).attr("height", y.bandwidth() )
.style("fill", function(d) { if(d.black_out==0) return "black" ; if(d.numerator==0){return "#5d8700"} 
return myColor(Math.min(+d.numerator,10))    } ).style("stroke-width", 4).style("stroke", "none").style("opacity", 0.8)
legend = working_space.append("g")
/* legend.selectAll().data(data, function(d) {return d.x_axis_column+':'+d.y_axis_column;}).join("text").attr("x", function(d) { return x(d.x_axis_column) }).attr("y", function(d) { return y(d.y_axis_column) +5})
.text(function(d) { return Math.round(d.val,2)*100} ).attr('text-size','6px')*/
}

function AreaChart(chart_id,data,axis){
    d3.select(chart_id).selectAll("*").remove();

    var data = d3.rollup(data, v => {
        return { 'x_axis': v[0][axis.x_axis],'y_axis':v[0][axis.y_axis] , 'num':
            d3.sum(v,  d =>  {if(d[axis.conditioned_column]!=axis.conditioned_value){ ;return 1} else{;return 0} } )  } }, d => d[axis.y_axis],d => d[axis.x_axis]  )
    
            data2 = []

   


    for ([key,value] of data.entries()){
        
        for([key2,value2] of value.entries()){
            if( value2.num == 0){
               
                data2.push(value2)
            }
        }
    }
   

    var plotdata = d3.rollup(data2,v=>{return {'y_axis':  d3.max(v,d=>d.y_axis),'x_axis':v[0].x_axis} },d=>d.x_axis)
    data = []

    window.val=''
    var y_axis_1 = 0
    var y_axis_2 = 0
    var x_axis_1 = 0
    var x_axis_2 = 0
var diff_1 = 1000000
var diff_2 = 10000000
    var prev_x = 0
    var prev_y = 0
    var iter_val = 0
    for ([key,value] of plotdata.entries()){
        if(iter_val == 0){
      
            prev_x = value.x_axis
            prev_y = value.y_axis
        }else{
           
            diff = value.y_axis - prev_y
    
            if(diff <= diff_1){
              
                y_axis_2 = y_axis_1
                diff_2 = diff_1
                y_axis_1 = value.y_axis
                diff_1 = diff
                x_axis_2 = x_axis_1
                x_axis_1 = value.x_axis
            }
            prev_x = value.x_axis
            prev_y = value.y_axis
        }
        data.push(value)
        iter_val  = iter_val+ 1;
      
    }

   $("#t1").html(formatValue(x_axis_1)  )
   $("#a1").html(Math.round(y_axis_1*100 )+"%")

   $("#t2").html(formatValue(x_axis_2)  )
   $("#a2").html(Math.round(y_axis_2*100 )+"%")

    const margin = {top: 10, right: 30, bottom: 30, left: 50}, width = 460 - margin.left - margin.right, height = 300 - margin.top - margin.bottom;


// append the svg object to the body of the page
var svg = d3.select(chart_id).append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform",`translate(${margin.left},${margin.top})`);



    // Add X axis --> it is a date format
    const x = d3.scaleLinear().domain(d3.extent(data, d => d.x_axis)).range([ 0, width ]);
    svg.append("g").attr("transform", `translate(0,  ${height+5})`).attr("class","white_axis_x").call(d3.axisBottom(x).ticks(5).tickSizeOuter(0).tickFormat(d => formatValue(d) )  );

    // Add Y axis
    const y = d3.scaleLinear().domain( d3.extent(data, d => +d.y_axis)).range([ height, 0 ]);
    svg.append("g").attr("transform", "translate(-5,0)").attr("class","white_axis").call(d3.axisLeft(y).ticks(5).tickSizeOuter(0).tickFormat(d3.format('.0%')) );

    // Add the area
    svg.append("path").datum(data).attr("fill", "#69b3a2").attr("fill-opacity", .3).attr("stroke", "none").attr("d", d3.area().x(d => x(d.x_axis)).y0( height ).y1(d => y(d.y_axis)))

  
    

    // Add the line
    svg.append("path").datum(data).attr("fill", "none").attr("stroke", "#69b3a2").attr("stroke-width", 4).attr("d", d3.line().x(d => x(d.x_axis)).y(d => y(d.y_axis)))

    // Add the line
    svg.selectAll("myCircles").data(data).join("circle").attr("fill", "red").attr("stroke", "none").attr("cx", d => x(d.x_axis)).attr("cy", d => y(d.y_axis)).attr("r", 3)



   

           
}


</script>

<script>
    width = $(window).width();

    ml = (width-1400)/2
    if(ml > 0){
    $(document.body).css('margin-left', ml);
   
}
    $("#simulate_start").click()
    start_script = 0

 
    set_compuattion = true

$("#section_2_metric").change(function () {
        metric = this.value;
        if(metric=='capx'){
            $("#section_2_ct").html("For a given target, higher agent comission have lower adherence to capx 18% ")
            $("#section_2_st").html("so, the staff comission should be minimum ")
            $("#metric_select_chart").html("Capx")
            
        axis_details =  {'x_axis_level_2_domain': new_Target_Range, 'x_axis_level_1_domain': agent_emar_comission_percentage_range, 'x_axis_level_2':'TARGET','x_axis_level_1':'agent_emar_comission_percentage', 'y_axis':'cap'}
        }else{
            $("#section_2_ct").html("For a given target, higher agent comission have lower Net Profit")
            $("#section_2_st").html("so, the staff comission should be minimum")
            axis_details =  {'x_axis_level_2_domain': new_Target_Range, 'x_axis_level_1_domain': agent_emar_comission_percentage_range, 'x_axis_level_2':'TARGET','x_axis_level_1':'agent_emar_comission_percentage', 'y_axis':'Net_Profit'}
            $("#metric_select_chart").html("Net Profit")
        }
        nested_x_axis_box_plot("#StaffPercentage_chart", ALL_Results_new.flat() ,axis_details)

    });


    $("#bins").change(function(){

        metric = this.value;
        axis_details = {'x_axis':'Achievement_TTL', 'color_by':'cap_bucket', 'achievemed_min':achievemed_min, 'achievemed_max':achievemed_max}
           draw_mixed_plot("#Actual_Achieved_byCapx",ALL_Results,axis_details,metric)
      
    })








</script>


<script>



</script>